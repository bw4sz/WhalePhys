{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Dive Data Exploration\"\nauthor: \"Ben Weinstein\"\ndate: \"May 14, 2017\"\noutput: \n  html_document:\n    toc: true\n---\n\n```{r setup, include=FALSE}\nlibrary(ggplot2)\nlibrary(chron)\nlibrary(dplyr)\nlibrary(data.table)\nlibrary(knitr)\nlibrary(maptools)\nopts_chunk$set(echo=F,warnings=F,messages=F,fig.height=8,fig.width=11)\n\n#get files\nf<-list.files(\"C:/Users/Ben/Dropbox/Whales/Data/Humpback/\",pattern=\"Behavior\",full.names=T,recursive = T)\ndat<-bind_rows(lapply(f,read.csv))\ndat$GMTtime<-as.POSIXct(dat$End,format=\"%H:%M:%S %d-%b-%Y\",tz=\"Etc/GMT+3\")\n\n#local time\ndat$timestamp<-as.POSIXct(format(dat$GMTtime,tz=\"Etc/GMT+3\"))\n\ndat$Month<-months(dat$timestamp)\ndat$Month<-factor(dat$Month,levels=month.name)\ndat$Hour<-strftime(dat$timestamp,format=\"%H\")\ndat$Year<-years(dat$timestamp)\n\n\n#create unique messages\nindices<-which(dat$What==\"Message\")\ncounter=1\ndat$ID<-NA\nfor (x in 1:(length(indices)-1)){\n  dat[indices[x]:indices[x+1],\"ID\"]<-counter\n  counter=counter+1\n}\n\ndive<-dat %>% filter(What==\"Dive\")%>% dplyr::select(Animal=Ptt,timestamp,Hour,Month,Year, ID,Start,DepthMax,DepthMin,DurationMax)\ndive<-dive[!is.na(dive$Month),]\n\n#remove duplicate data\ndive<-dive %>% arrange(Animal,timestamp) \ndive<-dive[!duplicated(dive),]\n```\n\n```{r}\n#Merge geographic data\n#get files\nf<-list.files(\"C:/Users/Ben/Dropbox/Whales/Data/Humpback\",pattern=\"Locations\",full.names=T,recursive = T)\ngdat<-lapply(f,function(x) read.csv(x,stringsAsFactors=F))\ngdat<-lapply(gdat,function(x){\n  x$Quality<-as.character(x$Quality)\n  return(x)\n}) \ngdat<-bind_rows(gdat)\n#timestamp\ngdat$Date<-as.POSIXct(gdat$Date,format=\"%H:%M:%S %d-%b-%Y\",tz=\"Etc/GMT+3\")\n```\n\n```{r}\nmessages<-dat %>% filter(dat$What==\"Message\")\nmessages$timestamp<-as.POSIXct(messages$End,format=\"%H:%M:%S %d-%b-%Y\",tz=\"Etc/GMT+3\")\n\n#look up the time interval that best fits\nsetDT(gdat)            ## convert to data.table by reference\nsetDT(messages)            ## same\n\n#dat[, timestamp := timestamp1]  ## create a duplicate of 'date1'\nsetkey(messages, timestamp)    ## set the column to perform the join on\nsetkey(gdat, Date)    ## same as above\n\nans = gdat[messages, roll=Inf] ## perform rolling join\nans<-as.data.frame(ans)\n\nmessage_join<-ans %>% select(Date,Animal=Ptt,Date,Quality,Latitude,Longitude,ID)\n\nmdat<-merge(dat,message_join,by=\"ID\")\nmdat<-mdat %>% filter(What==\"Dive\")\n\nmdat<-mdat %>% select(ID,Animal,Latitude,Longitude,timestamp,Start,End,Date,Month,Hour,Year,DepthMax,DepthMin,Quality,DurationMax,DurationMin)\n\n#only focus on Antarctic Peninsula\n\n#crop by extent\nd<-SpatialPointsDataFrame(cbind(mdat$Longitude,mdat$Latitude),data=data.frame(mdat),proj4string=CRS(\"+proj=longlat +datum=WGS84\"))\n\ncropoly<-readShapePoly(\"Data/CutPolygon.shp\",proj4string=CRS(\"+proj=longlat +datum=WGS84\"))\n\nb<-d[!is.na(d %over% cropoly)[,2],]\n\nmdat<-b@data\n\n```\n\n\n## What is the temporal coverage of the dataset? \n\nAre there broad scale patterns of maximum dive depth over time.\n\n```{r}\n#mdat depth and time\nggplot(mdat,aes(x=timestamp,y=DepthMax)) + geom_point()  + scale_x_datetime(date_breaks = \"2 week\",date_labels = \"%m/%d/%y\") + scale_y_reverse() + theme_bw() + labs(x=\"Date\")\nggsave(\"Figures/Depth_Time.jpg\",height=5,width=5)\n```\n\n## The proportion of dives at each depth.\n\n```{r}\nmdat20<-mdat %>% filter(DepthMax>20)\n\nmdat20$Interval<-cut(mdat20$DepthMax,seq(0,500,50))\n\npermonth<-mdat20 %>% group_by(Month) %>% summarize(n=n()) \nmonth_inter<-table(mdat20$Month,mdat20$Interval)\n\nmonth_inter<-merge(month_inter,permonth,by.x=\"Var1\",by.y=\"Month\")\nmonth_inter$prop<-month_inter$Freq/month_inter$n\n\nmonth_inter$Var2<-factor(month_inter$Var2,levels=rev(levels(month_inter$Var2)))\nggplot(month_inter) + geom_tile(aes(x=Var1,y=Var2,fill=prop*100)) + labs(x=\"Month\",y=\"mdat Bin\",fill=\"%\") + scale_fill_continuous(low=\"blue\",high=\"red\")\n\n```\n\n### By Individual\n\n```{r}\nmdat20<-mdat %>% filter(DepthMax>20,!Animal %in% c(131111,131128,131115,131116))\n\nmdat20$Interval<-cut(mdat20$DepthMax,seq(0,500,50))\n\npermonth<-mdat20 %>% group_by(Month,Animal) %>% summarize(n=n()) \nmonth_inter<-melt(table(mdat20$Month,mdat20$Animal,mdat20$Interval))\n\ncolnames(month_inter)<-c(\"Month\",\"Animal\",\"Interval\",\"mdats\")\n\nmonth_inter<-merge(month_inter,permonth,by=c(\"Animal\",\"Month\"))\nmonth_inter$prop<-month_inter$mdats/month_inter$n\n\nmonth_inter$Interval<-factor(month_inter$Interval,levels=rev(levels(month_inter$Interval)))\nggplot(month_inter) + geom_tile(aes(x=Month,y=Interval,fill=prop*100)) + labs(x=\"Month\",y=\"mdat Bin\",fill=\"%\") + scale_fill_continuous(low=\"blue\",high=\"red\") + facet_wrap(~Animal,scales=\"free\")\n\n```\n\n## By individual\n\n```{r}\nggplot(mdat,aes(x=timestamp,y=DepthMax)) + geom_point() + geom_smooth() + scale_x_datetime(date_breaks = \"2 week\") + scale_y_reverse() + facet_wrap(~Animal,scales=\"free\")\nggsave(\"Figures/Depth_Time.jpg\",height=5,width=5)\n```\n\n## By Month\n```{r}\nggplot(mdat,aes(x=timestamp,y=DepthMax,col=Month)) + geom_point()  + scale_y_reverse() + facet_wrap(~Animal,scales=\"free_x\") + labs(col=\"Animal\",x=\"Time\") + scale_x_datetime(date_breaks = \"2 week\",date_labels = \"%m/%d/%y\")\n```\n\n```{r}\nmdat %>% group_by(Month) %>% summarize(Average_Depth=mean(DepthMax))\n```\n\n##Daily patterns of maximum dive depth \n\n```{r}\n\nggplot(data=mdat,aes(x=as.numeric(Hour),y=DepthMax)) + geom_boxplot(aes(group=Hour)) + geom_smooth() + scale_y_reverse() + facet_wrap(~Month) + scale_x_continuous(breaks=seq(0,24,4)) + labs(x=\"Hour\",y=\"Max Depth\")\n\n#timestamp\nggplot(data=mdat,aes(x=as.numeric(Hour),y=DepthMax,col=as.factor(Animal))) + geom_point() + geom_smooth() + scale_y_reverse() + facet_wrap(~Month) + scale_x_continuous(breaks=seq(0,24,4))\n```\n\n## Where are the deep dives?\n\n### By individual\n\n```{r}\n#Bind geographic data to mdat data.\nmaxD<-mdat %>% group_by(Animal,Latitude,Longitude,ID,Date) %>% summarize(m=max(DepthMax))\n\namat<-maxD %>% arrange(Animal,Date)\nggplot(amat,aes(x=Longitude,y=Latitude)) + geom_point(aes(col=m,size=m)) + borders(fill=\"black\") + coord_cartesian(ylim = c(-65,-61),xlim=c(-55,-67)) + theme_bw() + scale_color_continuous(low=\"blue\",high=\"red\") + facet_wrap(~Animal) + geom_path(aes(group=1)) + labs(col=\"Max Depth\")\n```\n\n### Summary rasters\n```{r}\n#as a raster\nspmat<-SpatialPointsDataFrame(SpatialPoints(cbind(amat$Longitude,amat$Latitude)),data=data.frame(amat))\n\nsumrast<-raster::rasterize(y=raster::raster(spmat,resolution=0.25),x=spmat,field=\"m\",fun=mean)\nggplot(amat,aes(x=Longitude,y=Latitude)) + geom_point() + borders(fill=\"black\") + coord_cartesian(ylim = c(-65,-61),xlim=c(-55,-67)) + theme_bw() + geom_tile(data=data.frame(raster::rasterToPoints(sumrast)),aes(x=x,y=y,fill=layer),alpha=0.6) + scale_fill_continuous(low=\"blue\",high=\"red\") + labs(fill=\"Mean Depth\")\n\n```\n\n```{r}\nsave.image(\"Data/DiveExploration.Rdata\")\n```\n\n",
    "created" : 1496691264668.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2148712362",
    "id" : "1B4C52CF",
    "lastKnownWriteTime" : 1494775326,
    "last_content_update" : 1494775326,
    "path" : "~/DiveData/Explore.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}