#how many observations per individual in each step
idx<-mdat %>% group_by(TrackID,step) %>% summarize(n=n())
colnames(idx)<-c("Track","step","jStep")
idx<-reshape2::acast(data=idx,Track~step)
#tracks
tracks<-length(unique(mdat$TrackID))
#steps per track
steps<-mdat %>% group_by(TrackID) %>% summarize(n=length(unique(step))) %>% .$n
#obs array
obs<-reshape2::melt(mdat,measure.vars=c("Longitude","Latitude"))
obs<-reshape2::acast(obs,TrackID~step~jStep~variable)
obs[!is.finite(obs)]<-NA
#argos class array
mdat$argos.lc<-factor(mdat$Quality,levels=c(3,2,1,0,"A","B"))
mdat$numargos<-as.numeric(mdat$argos.lc)
obs_class<-reshape2::acast(mdat,TrackID~step~jStep,value.var="numargos")
#set interpolated observations to having lowest class of argos error
obs_class[!is.finite(obs_class)]<-6
#average dive depth array
maxdive<-reshape2::acast(mdat,TrackID~step~jStep,value.var="DepthMax")
#fill the empty values
maxdive[!is.finite(maxdive)]<-NA
# Chunk 15
# Chunk 16
#source jags file
source("Bayesian/NestedDiveRagged.R")
#prior cov shape
R <- diag(c(1,1))
data=list(divedepth=maxdive,argos=obs,steps=steps,R=R,j=j,idx=idx,tracks=tracks,argos_class=obs_class)
#paramters to track
pt<-c("alpha","sub_alpha","gamma","depth_mu","depth_tau","state", "sub_state","E","Enew")
if(newModel){
system.time(diving<-jags(model.file = "Bayesian/NestedDive_NoInd.jags",data=data,n.chains=2,parameters.to.save=pt,n.iter=100,n.burnin=0,n.thin=2,DIC=FALSE,codaOnly = c("state", "sub_state")))
}
# Chunk 17
print("model complete")
#bind chains
names(diving$samples)<-1:length(diving$samples)
pc_dive<-melt(lapply(diving$samples, as.data.frame))
pc_dive<-pc_dive %>% dplyr::select(chain=L1,variable,value) %>% group_by(chain,variable) %>% mutate(Draw=1:n()) %>% dplyr::select(Draw,chain,par=variable,value)
#extract parameter name
pc_dive$parameter<-data.frame(str_match(pc_dive$par,"(\\w+)"))[,-1]
#Extract index
splitpc<-split(pc_dive,pc_dive$parameter)
#single index
splitpc[c("alpha","gamma")]<-lapply(splitpc[c("alpha","gamma")],function(x){
sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
pc<-data.frame(x,Behavior=sv)
return(pc)
})
#double index
splitpc[c("depth_mu","depth_tau","sub_alpha")]<-lapply(splitpc[c("depth_mu","depth_tau","sub_alpha")],function(x){
sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+),(\\d+)"))[,3:4]
colnames(sv)<-c("Behavior","sub_state")
pc<-data.frame(x,sv)
return(pc)
})
#3 index
splitpc[c("state")]<-lapply(splitpc[c("state")],function(x){
sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+),(\\d+)]"))[,3:4]
colnames(sv)<-c("TrackID","step")
pc<-data.frame(x,sv)
return(pc)
})
#4 index
splitpc[c("sub_state","E","Enew")]<-lapply(splitpc[c("sub_state","E","Enew")],function(x){
sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+),(\\d+),(\\d+)]"))[,3:5]
colnames(sv)<-c("TrackID","step","jStep")
pc<-data.frame(x,sv)
return(pc)
})
#bind all matrices back together
pc_dive<-bind_rows(splitpc)
rm(splitpc)
# Chunk 18
ggplot(pc_dive[!pc_dive$parameter %in% c("dive_new","state","sub_state","E","Enew"),],aes(x=Draw,y=value,col=as.factor(chain))) + geom_line() + facet_wrap(~par,scales="free")
#posteriors
ggplot(pc_dive[!pc_dive$parameter %in% c("dive_new","state","sub_state","E","Enew"),],aes(x=value,fill=as.factor(chain))) + geom_histogram() + facet_wrap(~par,scales="free")
#sum table
sumtable<-pc_dive %>% filter(!parameter %in% c("dive_new","state","eval","sub_state","E","Enew")) %>% group_by(parameter,Behavior,sub_state) %>% summarize(mean=round(mean(value),3),upper=round(quantile(value,0.95),3),lower=round(quantile(value,0.05),3))
write.csv(sumtable,"Figures/sumtable.csv",row.names = F)
#Animal lookup table
pc_dive<-mdat %>% ungroup() %>%  dplyr::select(Animal,TrackID,Track)  %>% distinct() %>% mutate(TrackID=as.factor(TrackID)) %>% full_join(pc_dive)
# Chunk 19
#Take the most common estimate of behavior
Mode <- function(x) {
ux <- unique(x)
ux[which.max(tabulate(match(x, ux)))]
}
#Combine posterior summary
mdat$Animal<-as.factor(mdat$Animal)
mdat$Track<-as.factor(mdat$Track)
mdat$step<-as.factor(mdat$step)
state_est<-pc_dive %>% group_by(Animal,Track,step,parameter) %>%  filter(parameter %in% c("state","sub_state")) %>% summarize(Behavior=Mode(value)) %>% ungroup()  %>% spread(parameter,Behavior)
state_est %>% group_by(state,sub_state) %>% summarize(n=n())
state_est$Animal<-as.factor(state_est$Animal)
state_est$Track<-as.factor(state_est$Track)
state_est$step<-as.factor(state_est$step)
state_est<-state_est %>% inner_join(mdat)
blookup<-data.frame(state=c(1,1,2,2),sub_state=c(1,2,1,2),Behavior=c("Traveling","Dummy","Foraging","Resting"))
state_est<-state_est %>% inner_join(blookup)
# Chunk 20
ggplot(state_est %>% filter(!is.na(DepthMax)),aes(x=timestamp,y=DepthMax,col=Behavior,group=Track)) + geom_point() + geom_line(size=0.1,aes(group=Track)) + facet_wrap(~Animal,scales="free",ncol=1) + theme_bw() + scale_y_reverse() + labs(x="Date",y="Dive Depth (m)")
ggsave("Figures/TemporalBehavior.svg",height=12,width=10)
ggsave("Figures/TemporalBehavior.jpeg",height=12,width=10)
# Chunk 21
ggplot(state_est %>% filter(!is.na(DepthMax)),aes(x=timestamp,y=-DepthMax,col=as.factor(state),group=step)) + geom_point() + geom_line(size=0.25,aes(group=Track)) + facet_wrap(~Animal,scales="free",ncol=1) + theme_bw()
# Chunk 22
ggplot(state_est,aes(x=timestamp,y=Behavior)) + geom_line(aes(group=1))  + geom_point() + facet_wrap(~Animal,scales="free",ncol=1) + theme_bw()
# Chunk 23
prop<-state_est %>% group_by(Animal,Behavior) %>% filter(is.na(Latitude)) %>% summarize(n=length(jStep)) %>% mutate(p=n/sum(n)) %>% dplyr::select(-n) %>% spread(Behavior,p)
# Chunk 24
#how many of each state to draw?
statecount<-state_est %>% group_by(Animal,Behavior) %>% filter(is.na(Latitude)) %>% summarize(n=length(jStep))
pred_dives<-list()
for(x in 1:nrow(statecount)){
state_index<-blookup[ blookup$Behavior %in% statecount$Behavior[x],"state"]
sub_state_index<-blookup[ blookup$Behavior %in%  statecount$Behavior[x],"sub_state"]
depth_tau<-pc_dive %>% filter(parameter %in% c("depth_tau"),Behavior==state_index,sub_state==sub_state_index)
depth_mu<-pc_dive %>% filter(parameter %in% c("depth_mu"),Behavior==state_index,sub_state==sub_state_index)
travel_dives<-data.frame(Animal=statecount[x,"Animal"],DepthMax=rtruncnorm(n=as.numeric(statecount[x,"n"]),mean=depth_mu$value,sd=1/sqrt(depth_tau$value),a=0),Behavior=statecount[x,"Behavior"])
pred_dives[[x]]<-travel_dives
}
pred_dives<-bind_rows(pred_dives)
ggplot(pred_dives) + geom_histogram(alpha=0.8,aes(x=DepthMax,fill=Behavior))  + theme_bw() + labs(x="Dive Depth (m)") +facet_wrap(~Behavior,scales="free")
ggplot(pred_dives) + geom_density(alpha=0.8,aes(x=DepthMax,fill=Behavior))  + theme_bw() + labs(x="Dive Depth (m)")
ggsave("Figures/DiveDensity.jpg",height=4,width=7)
ggplot(pred_dives)  + geom_histogram(data=mdat,aes(x=DepthMax),col="black")+ geom_histogram(alpha=0.8,aes(x=DepthMax,fill=Behavior))  + theme_bw() + labs(x="Dive Depth (m)")
ggsave("Figures/DiveHist.jpg",height=4,width=7)
ggplot(pred_dives)  +  geom_density(alpha=0.8,aes(x=DepthMax),col='red')  + theme_bw() + labs(x="Dive Depth (m)") +geom_density(data=mdat,aes(x=DepthMax),col="black",size=1.5) + theme_bw() + labs(x="Dive Depth (m)")
ggsave("Figures/DivePredict.jpg",height=4,width=7)
ggplot(pred_dives)  +  geom_density(alpha=0.8,aes(x=DepthMax),col='red')  + theme_bw() + labs(x="Dive Depth (m)") +geom_density(data=mdat,aes(x=DepthMax),col="black",size=1.5) + facet_wrap(~Animal) + theme_bw() + labs(x="Dive Depth (m)")
# Chunk 25
ggplot(data=state_est) + geom_boxplot(aes(x=as.factor(LocalHour),y=DepthMax,fill=Behavior)) + ylab("Dive Depth (m)")+ labs(x="Hour (Local GMT+3)")
ggsave("Figures/Diel.svg")
ggsave("Figures/Diel.png",height=5,width=8,unit="in")
ggplot(data=state_est) + geom_boxplot(aes(x=as.factor(LocalHour),y=DepthMax,fill=Behavior)) + ylab("Dive Depth (m)") + facet_wrap(~Month) + labs(x="Hour (Local GMT+3)")
ggsave("Figures/DielbyMonth.svg")
ggsave("Figures/DielbyMonth.png",height=5,width=10,unit="in")
# Chunk 26
state_est$Month<-factor(state_est$Month,levels=month.name)
ggplot(data=state_est) + geom_boxplot(aes(x=Month,y=DepthMax,fill=Behavior)) + ylab("Dive Depth (m)")
ggsave("Figures/Month.svg")
ggsave("Figures/Month.png",height=5,width=8,unit="in")
ggplot(data=state_est) + geom_density(aes(x=DepthMax,fill=Month)) + ylab("Dive Depth (m)") + facet_wrap(~Behavior,scale="free",ncol=1)
# Chunk 27
state_est<-state_est %>% arrange(Animal,Track,timestamp)
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=Behavior),size=0.5) + mytheme
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=Behavior),size=0.5) + mytheme +facet_wrap(~Animal)
#Show nested behaviors
state_est$TopLayer<-NA
state_est[state_est$state==1,"TopLayer"]<-"Traveling"
state_est[state_est$state==2,"TopLayer"]<-"Area-restricted Search"
state_est$SecondLayer<-state_est$Behavior
state_est<-gather(state_est,key="Layer",value="estimate",TopLayer:SecondLayer)
state_est$Layer<-factor(state_est$Layer,levels = c("TopLayer","SecondLayer"),labels=c("Top Layer","Second Layer"))
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("plum","Red","Green","Blue")) + labs(col="Behavior")
ggsave("Figures/NestedMap.jpeg",height=8,width=11)
# Chunk 28
ggplot(state_est,aes(x=LocalHour,y=DepthMax,col=Behavior)) + geom_smooth(method = "gam", formula = y ~ s(x, k = 5)) + facet_wrap(~Animal)
# Chunk 29
byhour<-state_est %>% group_by(Animal,LocalHour,Behavior) %>% summarize(n=n()) %>% mutate(prop=n/sum(n))
ggplot(byhour,aes(x=LocalHour,y=prop,col=Behavior)) + geom_line()  + geom_point() + facet_wrap(~Animal,scales="free",ncol=1) + theme_bw() + scale_y_continuous(labels=scales::percent)
# Chunk 30
byhour<-state_est %>% group_by(LocalHour,Behavior) %>% summarize(n=n()) %>% mutate(prop=n/sum(n))
ggplot(byhour,aes(x=LocalHour,y=prop,col=Behavior)) + geom_line()  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour")
ggsave("Figures/DielFreq.svg",height=6,width=9)
ggsave("Figures/DielFreq.png",height=6,width=9)
# Chunk 31
bymonth<-state_est %>% group_by(Animal,Month,Behavior) %>% summarize(n=n()) %>% mutate(prop=n/sum(n)) %>% filter(!is.na(Month)) %>% filter(Behavior %in% c("Foraging","Resting"))
bymonth$Month<-factor(bymonth$Month,levels=month.name)
ggplot(bymonth,aes(x=Month,y=prop,col=Behavior)) + geom_line(aes(group=paste(Animal,Behavior)))  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent)
ggplot(bymonth,aes(x=Month,y=prop,fill=Behavior)) + geom_boxplot() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent)
ggsave("Figures/MonthFreq.svg",height=6,width=9)
ggsave("Figures/MonthFreq.png",height=6,width=9)
# Chunk 33
#By Animal
fitstat<-pc_dive %>% filter(parameter %in% c("E","Enew")) %>% group_by(parameter,Draw,chain,Animal) %>% summarize(fit=mean(value))
fitstat<-dcast(fitstat,Animal+Draw+chain~parameter,value.var="fit")
ymin<-min(c(fitstat$E,fitstat$Enew)) - min(c(fitstat$E,fitstat$Enew)) * .1
ymax<-max(c(fitstat$E,fitstat$Enew)) + max(c(fitstat$E,fitstat$Enew)) * .1
ggplot(fitstat,aes(x=E,y=Enew)) + geom_point() + theme_bw() + labs(x="Discrepancy of observed data",y="Discrepancy of replicated data") + geom_abline() + coord_fixed() + facet_wrap(~Animal,scale="free")
ggsave("Figures/PosteriorCheckAnimal.jpg",height = 4,width = 4)
fitstat %>% group_by() %>% summarize(mean(E),var(Enew))
# Chunk 34
#save.image("/Users/Ben/Dropbox/Whales/Dive/WhalePhys.RData")
#ymin<-min(c(fitstat$E,fitstat$Enew)) - min(c(fitstat$E,fitstat$Enew)) * .1
#ymax<-max(c(fitstat$E,fitstat$Enew)) + max(c(fitstat$E,fitstat$Enew)) * .1
ggplot(fitstat,aes(x=E,y=Enew)) + geom_point() + theme_bw() + labs(x="Discrepancy of observed data",y="Discrepancy of replicated data") + geom_abline() + facet_wrap(~Animal,scale="free")
ggplot(fitstat,aes(x=E,y=Enew)) + geom_point() + theme_bw() + labs(x="Discrepancy of observed data",y="Discrepancy of replicated data") + geom_abline() + coord_fixed() + facet_wrap(~Animal,scale="free",space="free")
ggplot(fitstat,aes(x=E,y=Enew)) + geom_point() + theme_bw() + labs(x="Discrepancy of observed data",y="Discrepancy of replicated data") + geom_abline() + coord_fixed() + facet_grid(~Animal,scale="free",space="free")
ggplot(fitstat,aes(x=E,y=Enew)) + geom_point() + theme_bw() + labs(x="Discrepancy of observed data",y="Discrepancy of replicated data") + geom_abline() + coord_fixed() + facet_grid(~Animal,scales="free",space="free")
ggplot(fitstat,aes(x=E,y=Enew)) + geom_point() + theme_bw() + labs(x="Discrepancy of observed data",y="Discrepancy of replicated data") + geom_abline() + coord_fixed() + facet_wrap(~Animal,scale="free")
fitstat<-pc_dive %>% filter(parameter %in% c("E","Enew")) %>% group_by(parameter,Draw,chain) %>% summarize(fit=mean(value))
fitstat<-dcast(fitstat,Draw+chain~parameter,value.var="value")
fitstat<-pc_dive %>% filter(parameter %in% c("E","Enew")) %>% group_by(parameter,Draw,chain) %>% summarize(fit=mean(value))
fitstat
fitstat<-dcast(fitstat,Draw+chain~parameter,value.var="fit")
ymin<-min(c(fitstat$E,fitstat$Enew)) - min(c(fitstat$E,fitstat$Enew)) * .1
ymax<-max(c(fitstat$E,fitstat$Enew)) + max(c(fitstat$E,fitstat$Enew)) * .1
ggplot(fitstat,aes(x=E,y=Enew)) + geom_point() + theme_bw() + labs(x="Discrepancy of observed data",y="Discrepancy of replicated data") + geom_abline() + coord_fixed() + ylim(ymin=ymin,ymax=ymax) + xlim(xmin=ymin,xmax=ymax)
fitstat %>% group_by() %>% summarize(mean(E),var(Enew))
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("plum","Red","Green","Blue")) + labs(col="Behavior")
colors
colors()
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("red","pink","orange","Blue")) + labs(col="Behavior")
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("red","deeppink","orange","Blue")) + labs(col="Behavior")
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("red","pink","orange","Blue")) + labs(col="Behavior")
colors()
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("red","violetred","orange","Blue")) + labs(col="Behavior")
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("red","violetred","pink","Blue")) + labs(col="Behavior")
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("red","violetred","pink","Blue")) + labs(col="Behavior")
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("red","violetred3","pink","Blue")) + labs(col="Behavior")
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("red","violetred3","pink","darkgreen")) + labs(col="Behavior")
colors()
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("tomato","violetred3","pink","darkgreen")) + labs(col="Behavior")
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("tomato","violetred3","pink","teal")) + labs(col="Behavior")
colors()
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("tomato","violetred3","pink","turquoise")) + labs(col="Behavior")
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("tomato","violetred3","pink","turquoise2")) + labs(col="Behavior")
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("tomato","violetred3","pink","turquoise3")) + labs(col="Behavior")
colors()
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("tomato","violetred3","pink","steelblue")) + labs(col="Behavior")
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.6) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("tomato","violetred3","pink","steelblue")) + labs(col="Behavior")
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.7) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("tomato","violetred3","pink","steelblue")) + labs(col="Behavior")
state_est$Layer<-factor(state_est$Layer,levels = c("TopLayer","SecondLayer"),labels=c("Horizontal Movement","Vertical Movement"))
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.7) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("tomato","violetred3","pink","steelblue")) + labs(col="Behavior")
ggsave("Figures/NestedMap.jpeg",height=8,width=11)
state_est<-state_est %>% arrange(Animal,Track,timestamp)
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=Behavior),size=0.5) + mytheme
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=Behavior),size=0.5) + mytheme +facet_wrap(~Animal)
#Show nested behaviors
state_est$TopLayer<-NA
state_est[state_est$state==1,"TopLayer"]<-"Traveling"
state_est[state_est$state==2,"TopLayer"]<-"Area-restricted Search"
state_est$SecondLayer<-state_est$Behavior
state_est<-gather(state_est,key="Layer",value="estimate",TopLayer:SecondLayer)
state_est$Layer<-factor(state_est$Layer,levels = c("TopLayer","SecondLayer"),labels=c("Horizontal Movement","Vertical Movement"))
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.7) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("tomato","violetred3","pink","steelblue")) + labs(col="Behavior")
ggsave("Figures/NestedMap.jpeg",height=8,width=11)
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=Behavior),size=0.5) + mytheme
#Take the most common estimate of behavior
Mode <- function(x) {
ux <- unique(x)
ux[which.max(tabulate(match(x, ux)))]
}
#Combine posterior summary
mdat$Animal<-as.factor(mdat$Animal)
mdat$Track<-as.factor(mdat$Track)
mdat$step<-as.factor(mdat$step)
state_est<-pc_dive %>% group_by(Animal,Track,step,parameter) %>%  filter(parameter %in% c("state","sub_state")) %>% summarize(Behavior=Mode(value)) %>% ungroup()  %>% spread(parameter,Behavior)
state_est %>% group_by(state,sub_state) %>% summarize(n=n())
state_est$Animal<-as.factor(state_est$Animal)
state_est$Track<-as.factor(state_est$Track)
state_est$step<-as.factor(state_est$step)
state_est<-state_est %>% inner_join(mdat)
blookup<-data.frame(state=c(1,1,2,2),sub_state=c(1,2,1,2),Behavior=c("Traveling","Dummy","Foraging","Resting"))
state_est<-state_est %>% inner_join(blookup)
state_est<-state_est %>% arrange(Animal,Track,timestamp)
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=Behavior),size=0.5) + mytheme
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=Behavior),size=0.5) + mytheme +facet_wrap(~Animal)
#Show nested behaviors
state_est$TopLayer<-NA
state_est[state_est$state==1,"TopLayer"]<-"Traveling"
state_est[state_est$state==2,"TopLayer"]<-"Area-restricted Search"
state_est$SecondLayer<-state_est$Behavior
state_est<-gather(state_est,key="Layer",value="estimate",TopLayer:SecondLayer)
head(state_est)
head(state_est$Latitude)
head(state_est$Layer)
state_est$Layer<-factor(state_est$Layer,levels = c("TopLayer","SecondLayer"),labels=c("Horizontal Movement","Vertical Movement"))
state_est$Layer
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.7) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("tomato","violetred3","pink","steelblue")) + labs(col="Behavior")
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.7) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("tomato","violetred3","pink","steelblue")) + labs(col="Behavior") + theme(legend.position="bottom")
ggplot(data=state_est) + geom_boxplot(aes(x=as.factor(LocalHour),y=DepthMax,fill=Behavior)) + ylab("Dive Depth (m)") + facet_wrap(~Month) + labs(x="Hour (Local GMT+3)")
ggplot(data=state_est) + geom_density(aes(x=DepthMax,fill=Month)) + ylab("Dive Depth (m)") + facet_wrap(~Behavior,scale="free",ncol=1)
ggplot(pred_dives)  +  geom_density(alpha=0.8,aes(x=DepthMax),col='red')  + theme_bw() + labs(x="Dive Depth (m)") +geom_density(data=mdat,aes(x=DepthMax),col="black",size=1.5) + theme_bw() + labs(x="Dive Depth (m)")
ggplot(pred_dives) + geom_density(alpha=0.8,aes(x=DepthMax,fill=Behavior))  + theme_bw() + labs(x="Dive Depth (m)")
ggplot(pred_dives) + geom_density(alpha=0.8,aes(x=DepthMax,fill=Behavior))  + theme_bw() + labs(x="Dive Depth (m)") +  scale_color_manual(values=c("tomato","violetred3","pink","steelblue"))
ggplot(pred_dives) + geom_density(alpha=0.8,aes(x=DepthMax,fill=Behavior))  + theme_bw() + labs(x="Dive Depth (m)") + scale_color_manual(values=c("tomato","violetred3","pink","steelblue"))
ggplot(pred_dives) + geom_density(alpha=0.8,aes(x=DepthMax,fill=Behavior))  + theme_bw() + labs(x="Dive Depth (m)") + scale_fill_manual(values=c("tomato","violetred3","pink","steelblue"))
ggplot(pred_dives) + geom_density(alpha=0.8,aes(x=DepthMax,fill=Behavior))  + theme_bw() + labs(x="Dive Depth (m)") + scale_fill_manual(values=c("violetred3","pink","steelblue"))
ggplot(bymonth,aes(x=Month,y=prop,fill=Behavior)) + geom_boxplot() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent)
ggplot(bymonth,aes(x=Month,y=prop,fill=Behavior)) + geom_boxplot() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + scale_fill_manual(values=c("violetred3","pink"))
ggplot(byhour,aes(x=LocalHour,y=prop,col=Behavior)) + geom_line()  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour")
ggplot(byhour,aes(x=LocalHour,y=prop,col=Behavior)) + geom_line()  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.1) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.7) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("tomato","violetred3","pink","steelblue")) + labs(col="Behavior") + theme(legend.position="bottom")
ggplot(state_est %>% filter(!is.na(DepthMax)),aes(x=timestamp,y=DepthMax,col=Behavior,group=Track)) + geom_point() + geom_line(size=0.1,aes(group=Track)) + facet_wrap(~Animal,scales="free",ncol=1) + theme_bw() + scale_y_reverse() + labs(x="Date",y="Dive Depth (m)")
ggplot(state_est %>% filter(!is.na(DepthMax)),aes(x=timestamp,y=DepthMax,col=Behavior,group=Track)) + geom_point() + geom_line(size=0.1,aes(group=Track)) + facet_wrap(~Animal,scales="free",ncol=1) + theme_bw() + scale_y_reverse() + labs(x="Date",y="Dive Depth (m)") + + scale_color_manual(values=c("violetred3","pink","steelblue"))
ggplot(state_est %>% filter(!is.na(DepthMax)),aes(x=timestamp,y=DepthMax,col=Behavior,group=Track)) + geom_point() + geom_line(size=0.1,aes(group=Track)) + facet_wrap(~Animal,scales="free",ncol=1) + theme_bw() + scale_y_reverse() + labs(x="Date",y="Dive Depth (m)") + scale_color_manual(values=c("violetred3","pink","steelblue"))
?jags
??jags
library(jagsUI)
?jags
5.082e4
5.082e4/60/60
library(tidyr)
library(ggplot2)
library(maptools)
library(shiny)
library(raster)
library(data.table)
library(ggmap)
library(leaflet)
library(dplyr)
library(stringr)
library(chron)
library(jagsUI)
library(boot)
library(knitr)
library(MCMCpack)
library(truncnorm)
newModel=T
opts_chunk$set(echo=F,warning=F,message=F,fig.width=11)
mytheme<-theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.text.y=element_blank(),axis.ticks.y=element_blank(),axis.title.x=element_blank(),axis.title.y=element_blank(),panel.grid=element_blank())
load("/Users/Ben/Dropbox/Whales/Dive/WhalePhys.RData")
state_est %>% head
prop
ggplot(state_est,aes(x=timestamp,y=Behavior)) + geom_line(aes(group=1))  + geom_point() + facet_wrap(~Animal,scales="free",ncol=1) + theme_bw()
state_est %>% group_by(Animal,Behavior) %>% filter(is.na(Latitude)) %>% summarize(n=length(jStep)) %>% mutate(p=n/sum(n)) %>% dplyr::select(-n) %>% spread(Behavior,p)
state_est %>% group_by(Behavior) %>% filter(is.na(Latitude)) %>% summarize(n=length(jStep)) %>% mutate(p=n/sum(n)) %>% dplyr::select(-n) %>% spread(Behavior,p)
prop$Foraging
mean(prop$Foraging)
sd(prop$Foraging)
sd(prop$Resting)
sd(prop$Resting,na.rm=T)
mean(prop$Resting,na.rm=T)
state_est %>% group_by(Behavior) %>% summarize(quantile(DepthMax,0.25))
state_est %>% group_by(Behavior) %>% summarize(quantile(DepthMax,0.25,na.rm-T))
state_est %>% group_by(Behavior) %>% summarize(quantile(DepthMax,0.25,na.rm=T))
state_est %>% group_by(Behavior) %>% summarize(25th=quantile(DepthMax,0.25,na.rm=T))
state_est %>% group_by(Behavior) %>% summarize(Quartile=quantile(DepthMax,0.25,na.rm=T))
state_est %>% group_by(Behavior) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T))
state_est %>% group_by(Behavior) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T))
state_est %>% group_by(Behavior) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T),max=max(DepthMax,na.rm=T))
state_est %>% group_by(Behavior) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T),max=max(DepthMax,na.rm=T),sum(MaxDepth>400))
state_est %>% group_by(Behavior) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T),max=max(DepthMax,na.rm=T),sum(DepthMax>400))
state_est %>% group_by(Behavior) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T),max=max(DepthMax,na.rm=T),sum(DepthMax>400,na.rm = T))
state_est %>% group_by(Behavior,Month) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T),max=max(DepthMax,na.rm=T),sum(DepthMax>400,na.rm = T))
state_est %>% group_by(Behavior,Month) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T),max=max(DepthMax,na.rm=T),s=sum(DepthMax>400,na.rm = T)) %>% filter(s>0)
state_est %>% group_by(Behavior,Month) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T),max=max(DepthMax,na.rm=T),s=sum(DepthMax>400,na.rm = T),mean(DepthMax)) %>% filter(s>0)
state_est %>% group_by(Behavior,Month) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T),max=max(DepthMax,na.rm=T),s=sum(DepthMax>400,na.rm = T),mean=mean(DepthMax,na.rm=T)) %>% filter(s>0)
state_est %>% group_by(Behavior,Month) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T),max=max(DepthMax,na.rm=T),s=sum(DepthMax>400,na.rm = T),mean=mean(DepthMax,na.rm=T)) %>% filter(s>0)
state_est %>% group_by(Behavior,Month) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T),max=max(DepthMax,na.rm=T),s=sum(DepthMax>400,na.rm = T),mean=mean(DepthMax,na.rm=T),n=n()) %>% filter(s>0)
state_est %>% group_by(Behavior,Month) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T),max=max(DepthMax,na.rm=T),s=sum(DepthMax>400,na.rm = T)/n(),mean=mean(DepthMax,na.rm=T),n=n()) %>% filter(s>0)
state_est %>% group_by(Behavior,Month) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T),max=max(DepthMax,na.rm=T),s=sum(DepthMax>400,na.rm = T)/n(),mean=mean(DepthMax,na.rm=T),n=n())
state_est %>% group_by(Behavior,Month) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T),max=max(DepthMax,na.rm=T),s=sum(DepthMax>400,na.rm = T),mean=mean(DepthMax,na.rm=T),n=n())
state_est %>% group_by(Behavior,Month) %>% summarize(LQuartile=quantile(DepthMax,0.25,na.rm=T),HQuartile=quantile(DepthMax,0.75,na.rm=T),max=max(DepthMax,na.rm=T),s=sum(DepthMax>400,na.rm = T)/n(),mean=mean(DepthMax,na.rm=T),n=n())
568+48
ggplot(state_est %>% filter(!is.na(DepthMax)),aes(x=timestamp,y=DepthMax,col=Behavior,group=Track)) + geom_point() + geom_line(size=0.1,aes(group=Track)) + facet_wrap(~Animal,scales="free",ncol=2) + theme_bw() + scale_y_reverse() + labs(x="Date",y="Dive Depth (m)") + scale_color_manual(values=c("violetred3","pink","steelblue"))
ggsave("Figures/TemporalBehavior.svg",height=12,width=12)
ggsave("Figures/TemporalBehavior.jpeg",height=12,width=12)
ggplot(state_est %>% filter(!is.na(DepthMax)),aes(x=timestamp,y=DepthMax,col=Behavior,group=Track)) + geom_point(size=0.3) + geom_line(size=0.1,aes(group=Track)) + facet_wrap(~Animal,scales="free",ncol=2) + theme_bw() + scale_y_reverse() + labs(x="Date",y="Dive Depth (m)") + scale_color_manual(values=c("violetred3","pink","steelblue"))
ggsave("Figures/TemporalBehavior.svg",height=12,width=12)
ggsave("Figures/TemporalBehavior.jpeg",height=12,width=12)
ggsave("Figures/TemporalBehavior.svg",height=10,width=12)
ggplot(state_est %>% filter(!is.na(DepthMax)),aes(x=timestamp,y=DepthMax,col=Behavior,group=Track)) + geom_point(size=0.5) + geom_line(size=0.1,aes(group=Track)) + facet_wrap(~Animal,scales="free",ncol=2) + theme_bw() + scale_y_reverse() + labs(x="Date",y="Dive Depth (m)") + scale_color_manual(values=c("violetred3","pink","steelblue"))
ggsave("Figures/TemporalBehavior.svg",height=10,width=12)
ggsave("Figures/TemporalBehavior.jpeg",height=10,width=12)
library(tidyr)
library(ggplot2)
library(maptools)
library(shiny)
library(raster)
library(data.table)
library(ggmap)
library(leaflet)
library(dplyr)
library(stringr)
library(chron)
library(jagsUI)
library(boot)
library(knitr)
library(MCMCpack)
library(truncnorm)
newModel=F
opts_chunk$set(echo=T,warning=F,message=F,fig.width=11)
mytheme<-theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.text.y=element_blank(),axis.ticks.y=element_blank(),axis.title.x=element_blank(),axis.title.y=element_blank(),panel.grid=element_blank())
load("/Users/Ben/Dropbox/Whales/Dive/WhalePhys.RData")
fitstat<-pc_dive %>% filter(parameter %in% c("E","Enew")) %>% group_by(parameter,Draw,chain) %>% summarize(fit=mean(value))
fitstat<-dcast(fitstat,Draw+chain~parameter,value.var="fit")
head(fitsstat)
head(fitstat)
fitstat<-pc_dive %>% filter(parameter %in% c("E","Enew")) %>% group_by(parameter,Draw,chain) %>% summarize(fit=mean(value))
head(fitstat)
pc_dive %>% distinct(parameter
)
library(tidyr)
library(ggplot2)
library(maptools)
library(shiny)
library(raster)
library(data.table)
library(ggmap)
library(leaflet)
library(dplyr)
library(stringr)
library(chron)
library(jagsUI)
library(boot)
library(knitr)
library(MCMCpack)
library(truncnorm)
newModel=F
opts_chunk$set(echo=T,warning=F,message=F,fig.width=11)
mytheme<-theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.text.y=element_blank(),axis.ticks.y=element_blank(),axis.title.x=element_blank(),axis.title.y=element_blank(),panel.grid=element_blank())
load("/Users/Ben/Dropbox/Whales/Dive/WhalePhys.RData")
sample(1:500,10)
sdraws<-sample(1:500,10)
schains<-sample(1:2,10)
library(tidyr)
library(ggplot2)
library(maptools)
library(shiny)
library(raster)
library(data.table)
library(ggmap)
library(leaflet)
library(dplyr)
library(stringr)
library(chron)
library(jagsUI)
library(boot)
library(knitr)
library(MCMCpack)
library(truncnorm)
newModel=F
opts_chunk$set(echo=T,warning=F,message=F,fig.width=11)
mytheme<-theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.text.y=element_blank(),axis.ticks.y=element_blank(),axis.title.x=element_blank(),axis.title.y=element_blank(),panel.grid=element_blank())
sdraws<-sample(1:500,10)
schains<-sample(1:2,10,replace=T)
schains
hour_estdraw<-pc_dive %>% filter(Draw %in% sdraws,chain %in% schains, parameter %in% c("state","sub_state"))  %>% dplyr::select(-par,-Behavior)  %>% spread(parameter,value) %>% ungroup()
sub_states<-hour_estdraw %>% dplyr::select(-state)
states<-hour_estdraw %>% filter(!is.na(state)) %>% dplyr::select(Draw,chain,Animal,TrackID,step,state)
pred_states<-sub_states %>% inner_join(states)
head(pred_states)
sub_states
tail(sub_states)
pred_states<-sub_states %>% inner_join(states)
pred_states
head(pred_states)
tail(pred_states)
bydraw<-pred_states%>% mutate(Animal=as.factor(Animal),TrackID=as.numeric(TrackID),jStep=as.numeric(jStep)) %>% inner_join(mdat) %>% group_by(Draw,chain,LocalHour,state,sub_state) %>% summarize(n=n()) %>% mutate(prop=n/sum(n)) %>% summarize(mean=mean(prop),lower=quantile(prop,0.05),upper=quantile(prop,0.95))
head(bydraw)
ggplot(bydraw,aes(x=LocalHour,y=mean,col=Behavior)) + geom_line()  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
bydraw<-pred_states%>% mutate(Animal=as.factor(Animal),TrackID=as.numeric(TrackID),jStep=as.numeric(jStep)) %>% inner_join(mdat) %>% group_by(Draw,chain,LocalHour,state,sub_state) %>% summarize(n=n()) %>% mutate(prop=n/sum(n)) %>% group_by(LocalHour,state,sub_state) summarize(mean=mean(prop),lower=quantile(prop,0.05),upper=quantile(prop,0.95))
bydraw<-pred_states%>% mutate(Animal=as.factor(Animal),TrackID=as.numeric(TrackID),jStep=as.numeric(jStep)) %>% inner_join(mdat) %>% group_by(Draw,chain,LocalHour,state,sub_state) %>% summarize(n=n()) %>% mutate(prop=n/sum(n)) %>% group_by(LocalHour,state,sub_state) %>% summarize(mean=mean(prop),lower=quantile(prop,0.05),upper=quantile(prop,0.95))
ggplot(bydraw,aes(x=LocalHour,y=mean,col=paste(state,sub_state)) + geom_line()  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
ggplot(bydraw,aes(x=LocalHour,y=mean,col=paste(state,sub_state)) + geom_line()  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
ggplot(bydraw,aes(x=LocalHour,y=mean,col=paste(state,sub_state))) + geom_line()  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
blookup
bydraw %>% inner_join(blookup)
#Label behaviors
bydraw<-bydraw %>% inner_join(blookup)
ggplot(bydraw,aes(x=LocalHour,y=mean,col=paste(state,sub_state))) + geom_line()  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
blookup
ggplot(bydraw,aes(x=LocalHour,y=mean,col=Behavior)) + geom_line()  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
sdraws<-sample(1:500,10)
schains<-sample(1:2,10,replace=T)
hour_estdraw<-pc_dive %>% filter(Draw %in% sdraws,chain %in% schains, parameter %in% c("state","sub_state"))  %>% dplyr::select(-par,-Behavior)  %>% spread(parameter,value) %>% ungroup()
#merge substates and states for each draw., step, jStep
sub_states<-hour_estdraw %>% dplyr::select(-state)
states<-hour_estdraw %>% filter(!is.na(state)) %>% dplyr::select(Draw,chain,Animal,TrackID,step,state)
pred_states<-sub_states %>% inner_join(states)
bydraw<-pred_states%>% mutate(Animal=as.factor(Animal),TrackID=as.numeric(TrackID),jStep=as.numeric(jStep)) %>% inner_join(mdat)  %>% inner_join(blookup) %>% group_by(Draw,chain,LocalHour,Behavior)  %>% summarize(n=n()) %>% mutate(prop=n/sum(n)) %>% summarize(mean=mean(prop),lower=quantile(prop,0.05),upper=quantile(prop,0.95))
#Label behaviors
bydraw<-bydraw
ggplot(bydraw,aes(x=LocalHour,y=mean,col=Behavior)) + geom_line()  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
bydraw
bydraw<-pred_states%>% mutate(Animal=as.factor(Animal),TrackID=as.numeric(TrackID),jStep=as.numeric(jStep)) %>% inner_join(mdat)  %>% inner_join(blookup) %>% group_by(Draw,chain,LocalHour,Behavior)  %>% summarize(n=n()) %>% mutate(prop=n/sum(n)) %>% group_by(Behavior) %>% summarize(mean=mean(prop),lower=quantile(prop,0.05),upper=quantile(prop,0.95))
ggplot(bydraw,aes(x=LocalHour,y=mean,col=Behavior)) + geom_line()  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
sdraws<-sample(1:500,10)
schains<-sample(1:2,10,replace=T)
hour_estdraw<-pc_dive %>% filter(Draw %in% sdraws,chain %in% schains, parameter %in% c("state","sub_state"))  %>% dplyr::select(-par,-Behavior)  %>% spread(parameter,value) %>% ungroup()
#merge substates and states for each draw., step, jStep
sub_states<-hour_estdraw %>% dplyr::select(-state)
states<-hour_estdraw %>% filter(!is.na(state)) %>% dplyr::select(Draw,chain,Animal,TrackID,step,state)
pred_states<-sub_states %>% inner_join(states)
bydraw<-pred_states%>% mutate(Animal=as.factor(Animal),TrackID=as.numeric(TrackID),jStep=as.numeric(jStep)) %>% inner_join(mdat)  %>% inner_join(blookup) %>% group_by(Draw,chain,LocalHour,Behavior)  %>% summarize(n=n()) %>% mutate(prop=n/sum(n)) %>% group_by(LocalHour,Behavior) %>% summarize(mean=mean(prop),lower=quantile(prop,0.05),upper=quantile(prop,0.95))
ggplot(bydraw,aes(x=LocalHour,y=mean,col=Behavior)) + geom_line()  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
ggplot(bydraw,aes(x=LocalHour,y=mean,col=Behavior)) + geom_ribbon(aes(ymin=lower,ymax=upper))  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
ggplot(bydraw,aes(x=LocalHour,y=mean,fill=Behavior)) + geom_ribbon(aes(ymin=lower,ymax=upper))  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
ggplot(bydraw,aes(x=LocalHour,y=mean,fill=Behavior)) + geom_ribbon(aes(ymin=lower,ymax=upper))  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_fill_manual(values=c("violetred3","pink","steelblue"))
sdraws<-sample(1:500,20)
schains<-sample(1:2,20,replace=T)
hour_estdraw<-pc_dive %>% filter(Draw %in% sdraws,chain %in% schains, parameter %in% c("state","sub_state"))  %>% dplyr::select(-par,-Behavior)  %>% spread(parameter,value) %>% ungroup()
#merge substates and states for each draw., step, jStep
sub_states<-hour_estdraw %>% dplyr::select(-state)
states<-hour_estdraw %>% filter(!is.na(state)) %>% dplyr::select(Draw,chain,Animal,TrackID,step,state)
pred_states<-sub_states %>% inner_join(states)
bydraw<-pred_states%>% mutate(Animal=as.factor(Animal),TrackID=as.numeric(TrackID),jStep=as.numeric(jStep)) %>% inner_join(mdat)  %>% inner_join(blookup) %>% group_by(Draw,chain,LocalHour,Behavior)  %>% summarize(n=n()) %>% mutate(prop=n/sum(n)) %>% group_by(LocalHour,Behavior) %>% summarize(mean=mean(prop),lower=quantile(prop,0.05),upper=quantile(prop,0.95))
ggplot(bydraw,aes(x=LocalHour,y=mean,fill=Behavior)) + geom_ribbon(aes(ymin=lower,ymax=upper))  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_fill_manual(values=c("violetred3","pink","steelblue"))
ggplot(bydraw,aes(x=LocalHour,y=mean,fill=Behavior)) + geom_line()  + geom_point() + geom_errorbar(aes(ymin=lower,ymax=upper)) theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_fill_manual(values=c("violetred3","pink","steelblue"))
ggplot(bydraw,aes(x=LocalHour,y=mean,fill=Behavior)) + geom_line()  + geom_point() + geom_errorbar(aes(ymin=lower,ymax=upper)) + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_fill_manual(values=c("violetred3","pink","steelblue"))
ggplot(bydraw,aes(x=LocalHour,y=mean,col=Behavior)) + geom_line()  + geom_point() + geom_errorbar(aes(ymin=lower,ymax=upper)) + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_fill_manual(values=c("violetred3","pink","steelblue"))
ggplot(bydraw,aes(x=LocalHour,y=mean,col=Behavior)) + geom_line()  + geom_point() + geom_errorbar(aes(ymin=lower,ymax=upper)) + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_col_manual(values=c("violetred3","pink","steelblue"))
ggplot(bydraw,aes(x=LocalHour,y=mean,col=Behavior)) + geom_line()  + geom_point() + geom_errorbar(aes(ymin=lower,ymax=upper)) + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
ggplot(bydraw,aes(x=LocalHour,y=mean,col=Behavior)) + geom_line()  + geom_point() + geom_errorbar(aes(ymin=lower,ymax=upper),col="black") + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
ggplot(bydraw,aes(x=LocalHour,y=mean,col=Behavior)) + geom_line()  + geom_point() + geom_errorbar(aes(ymin=lower,ymax=upper),size=0.3) + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
ggsave("Figures/Diel_with_bars.jpeg")
ggsave("Figures/Diel_with_bars.jpeg",height=5,width = 7,dpi=500)
sdraws<-sample(1:500,50)
schains<-sample(1:2,50,replace=T)
hour_estdraw<-pc_dive %>% filter(Draw %in% sdraws,chain %in% schains, parameter %in% c("state","sub_state"))  %>% dplyr::select(-par,-Behavior)  %>% spread(parameter,value) %>% ungroup()
#merge substates and states for each draw., step, jStep
sub_states<-hour_estdraw %>% dplyr::select(-state)
states<-hour_estdraw %>% filter(!is.na(state)) %>% dplyr::select(Draw,chain,Animal,TrackID,step,state)
pred_states<-sub_states %>% inner_join(states)
bydraw<-pred_states%>% mutate(Animal=as.factor(Animal),TrackID=as.numeric(TrackID),jStep=as.numeric(jStep)) %>% inner_join(mdat)  %>% inner_join(blookup) %>% group_by(Draw,chain,LocalHour,Behavior)  %>% summarize(n=n()) %>% mutate(prop=n/sum(n)) %>% group_by(LocalHour,Behavior) %>% summarize(mean=mean(prop),lower=quantile(prop,0.05),upper=quantile(prop,0.95))
ggplot(bydraw,aes(x=LocalHour,y=mean,col=Behavior)) + geom_line()  + geom_point() + geom_errorbar(aes(ymin=lower,ymax=upper),size=0.3) + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour") + scale_color_manual(values=c("violetred3","pink","steelblue"))
ggsave("Figures/Diel_with_bars.jpeg",height=5,width = 7,dpi=500)
