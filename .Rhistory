j<-reshape2::acast(mdat,TrackID~step~jStep,value.var="j")
#how many observations per individual in each step
idx<-mdat %>% group_by(TrackID,step) %>% summarize(n=n())
colnames(idx)<-c("Track","step","jStep")
idx<-reshape2::acast(data=idx,Track~step)
#tracks
tracks<-length(unique(mdat$TrackID))
#steps per track
steps<-mdat %>% group_by(TrackID) %>% summarize(n=length(unique(step))) %>% .$n
#obs array
obs<-reshape2::melt(mdat,measure.vars=c("Longitude","Latitude"))
obs<-reshape2::acast(obs,TrackID~step~jStep~variable)
obs[!is.finite(obs)]<-NA
#argos class array
mdat$argos.lc<-factor(mdat$Quality,levels=c(3,2,1,0,"A","B"))
mdat$numargos<-as.numeric(mdat$argos.lc)
obs_class<-reshape2::acast(mdat,TrackID~step~jStep,value.var="numargos")
#set interpolated observations to having lowest class of argos error
obs_class[!is.finite(obs_class)]<-6
#average dive depth array
maxdive<-reshape2::acast(mdat,TrackID~step~jStep,value.var="DepthMax")
#fill the empty values
maxdive[!is.finite(maxdive)]<-NA
# Chunk 15
# Chunk 16
#source jags file
source("Bayesian/NestedDiveRagged.R")
#prior cov shape
R <- diag(c(1,1))
data=list(divedepth=maxdive,argos=obs,steps=steps,R=R,j=j,idx=idx,tracks=tracks,argos_class=obs_class)
#paramters to track
pt<-c("alpha","sub_alpha","gamma","depth_mu","depth_tau","state", "sub_state")
if(newModel){
system.time(diving<-jags(model.file = "Bayesian/NestedDive_NoInd.jags",data=data,n.chains=2,parameters.to.save=pt,n.iter=3000,n.burnin=2500,n.thin=2,DIC=FALSE,codaOnly = c("state", "sub_state")))
}
# Chunk 17
print("model complete")
#bind chains
names(diving$samples)<-1:length(diving$samples)
pc_dive<-melt(lapply(diving$samples, as.data.frame))
pc_dive<-pc_dive %>% dplyr::select(chain=L1,variable,value) %>% group_by(chain) %>% mutate(Draw=1:n()) %>% dplyr::select(Draw,chain,par=variable,value)
#extract parameter name
pc_dive$parameter<-data.frame(str_match(pc_dive$par,"(\\w+)"))[,-1]
#Extract index
splitpc<-split(pc_dive,pc_dive$parameter)
#single index
splitpc[c("alpha","gamma")]<-lapply(splitpc[c("alpha","gamma")],function(x){
sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
pc<-data.frame(x,Behavior=sv)
return(pc)
})
#double index
splitpc[c("depth_mu","depth_tau","sub_alpha")]<-lapply(splitpc[c("depth_mu","depth_tau","sub_alpha")],function(x){
sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+),(\\d+)"))[,3:4]
colnames(sv)<-c("Behavior","sub_state")
pc<-data.frame(x,sv)
return(pc)
})
#3 index
splitpc[c("state")]<-lapply(splitpc[c("state")],function(x){
sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+),(\\d+)"))[,3:4]
colnames(sv)<-c("TrackID","step")
pc<-data.frame(x,sv)
return(pc)
})
#4 index
splitpc[c("sub_state")]<-lapply(splitpc[c("sub_state")],function(x){
sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+),(\\d+),(\\d+)]"))[,3:5]
colnames(sv)<-c("TrackID","step","jStep")
pc<-data.frame(x,sv)
return(pc)
})
#bind all matrices back together
pc_dive<-bind_rows(splitpc)
rm(splitpc)
# Chunk 18
ggplot(pc_dive[!pc_dive$parameter %in% c("dive_new","state","sub_state"),],aes(x=Draw,y=value,col=as.factor(chain))) + geom_line() + facet_wrap(~par,scales="free")
#posteriors
ggplot(pc_dive[!pc_dive$parameter %in% c("dive_new","state","sub_state"),],aes(x=value,fill=as.factor(chain))) + geom_histogram() + facet_wrap(~par,scales="free")
#sum table
pc_dive %>% filter(!parameter %in% c("dive_new","state","eval","sub_state")) %>% group_by(parameter,Behavior,sub_state) %>% summarize(mean=round(mean(value),3),upper=round(quantile(value,0.95),3),lower=round(quantile(value,0.05),3))
#Animal lookup table
pc_dive<-mdat %>% ungroup() %>%  dplyr::select(Animal,TrackID,Track)  %>% distinct() %>% mutate(TrackID=as.factor(TrackID)) %>% full_join(pc_dive)
# Chunk 19
#Take the most common estimate of behavior
Mode <- function(x) {
ux <- unique(x)
ux[which.max(tabulate(match(x, ux)))]
}
#Combine posterior summary
mdat$Animal<-as.factor(mdat$Animal)
mdat$Track<-as.factor(mdat$Track)
mdat$step<-as.factor(mdat$step)
state_est<-pc_dive %>% group_by(Animal,Track,step,parameter) %>%  filter(parameter %in% c("state","sub_state")) %>% summarize(Behavior=Mode(value)) %>% ungroup()  %>% spread(parameter,Behavior)
state_est %>% group_by(state,sub_state) %>% summarize(n=n())
state_est$Animal<-as.factor(state_est$Animal)
state_est$Track<-as.factor(state_est$Track)
state_est$step<-as.factor(state_est$step)
state_est<-state_est %>% inner_join(mdat)
blookup<-data.frame(state=c(1,1,2,2),sub_state=c(1,2,1,2),Behavior=c("Traveling","Dummy","Foraging","Resting"))
state_est<-state_est %>% inner_join(blookup)
# Chunk 20
ggplot(state_est %>% filter(!is.na(DepthMax)),aes(x=timestamp,y=DepthMax,col=Behavior,group=Track)) + geom_point() + geom_line(size=0.1,aes(group=Track)) + facet_wrap(~Animal,scales="free",ncol=1) + theme_bw() + scale_y_reverse() + labs(x="Date",y="Dive Depth (m)")
ggsave("Figures/TemporalBehavior.svg",height=12,width=10)
ggsave("Figures/TemporalBehavior.jpeg",height=12,width=10)
# Chunk 21
ggplot(state_est %>% filter(!is.na(DepthMax)),aes(x=timestamp,y=-DepthMax,col=as.factor(state),group=step)) + geom_point() + geom_line(size=0.25,aes(group=Track)) + facet_wrap(~Animal,scales="free",ncol=1) + theme_bw()
# Chunk 22
ggplot(state_est,aes(x=timestamp,y=Behavior)) + geom_line(aes(group=1))  + geom_point() + facet_wrap(~Animal,scales="free",ncol=1) + theme_bw()
# Chunk 23
#how many of each state to draw?
statecount<-state_est %>% group_by(Animal,Behavior) %>% filter(is.na(Latitude)) %>% summarize(n=length(jStep))
pred_dives<-list()
for(x in 1:nrow(statecount)){
state_index<-blookup[ blookup$Behavior %in% statecount$Behavior[x],"state"]
sub_state_index<-blookup[ blookup$Behavior %in%  statecount$Behavior[x],"sub_state"]
depth_tau<-pc_dive %>% filter(parameter %in% c("depth_tau"),Behavior==state_index,sub_state==sub_state_index)
depth_mu<-pc_dive %>% filter(parameter %in% c("depth_mu"),Behavior==state_index,sub_state==sub_state_index)
travel_dives<-data.frame(Animal=statecount[x,"Animal"],DepthMax=rtruncnorm(n=as.numeric(statecount[x,"n"]),mean=depth_mu$value,sd=1/sqrt(depth_tau$value),a=0),Behavior=statecount[x,"Behavior"])
pred_dives[[x]]<-travel_dives
}
pred_dives<-bind_rows(pred_dives)
ggplot(pred_dives) + geom_histogram(alpha=0.8,aes(x=DepthMax,fill=Behavior))  + theme_bw() + labs(x="Dive Depth (m)") +facet_wrap(~Behavior,scales="free")
ggplot(pred_dives)  + geom_histogram(data=mdat,aes(x=DepthMax),col="black")+ geom_histogram(alpha=0.8,aes(x=DepthMax,fill=Behavior))  + theme_bw() + labs(x="Dive Depth (m)")
ggsave("Figures/DiveHist.jpg",height=4,width=7)
ggplot(pred_dives)  +  geom_density(alpha=0.8,aes(x=DepthMax),col='red')  + theme_bw() + labs(x="Dive Depth (m)") +geom_density(data=mdat,aes(x=DepthMax),col="black",size=1.5) + theme_bw() + labs(x="Dive Depth (m)")
ggsave("Figures/DivePredict.jpg",height=4,width=7)
ggplot(pred_dives)  +  geom_density(alpha=0.8,aes(x=DepthMax),col='red')  + theme_bw() + labs(x="Dive Depth (m)") +geom_density(data=mdat,aes(x=DepthMax),col="black",size=1.5) + facet_wrap(~Animal) + theme_bw() + labs(x="Dive Depth (m)")
# Chunk 24
ggplot(data=state_est) + geom_boxplot(aes(x=as.factor(LocalHour),y=DepthMax,fill=Behavior)) + ylab("Dive Depth (m)")+ labs(x="Hour (Local GMT+3)")
ggsave("Figures/Diel.svg")
ggsave("Figures/Diel.png",height=5,width=8,unit="in")
ggplot(data=state_est) + geom_boxplot(aes(x=as.factor(LocalHour),y=DepthMax,fill=Behavior)) + ylab("Dive Depth (m)") + facet_wrap(~Month) + labs(x="Hour (Local GMT+3)")
ggsave("Figures/DielbyMonth.svg")
ggsave("Figures/DielbyMonth.png",height=5,width=10,unit="in")
# Chunk 25
ggplot(data=state_est) + geom_boxplot(aes(x=Month,y=DepthMax,fill=Behavior)) + ylab("Maximum Dive Depth (km)")
ggsave("Figures/Month.svg")
ggsave("Figures/Month.png",height=5,width=8,unit="in")
# Chunk 26
state_est<-state_est %>% arrange(Animal,Track,timestamp)
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=Behavior),size=0.5) + mytheme
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=Behavior),size=0.5) + mytheme +facet_wrap(~Animal)
#Show nested behaviors
state_est$TopLayer<-NA
state_est[state_est$state==1,"TopLayer"]<-"Traveling"
state_est[state_est$state==2,"TopLayer"]<-"Area-restricted Search"
state_est$SecondLayer<-state_est$Behavior
state_est<-gather(state_est,key="Layer",value="estimate",TopLayer:SecondLayer)
state_est$Layer<-factor(state_est$Layer,levels = c("TopLayer","SecondLayer"),labels=c("Top Layer","Second Layer"))
ggmap(troy) +geom_path(data=state_est %>% filter(!is.na(Latitude)),aes(x=Longitude, y=Latitude,group=paste(Animal,Track)),size=0.5) + geom_point(data=state_est,aes(x=Longitude, y=Latitude,col=estimate),size=0.5) + mytheme +facet_wrap(~Layer) + scale_color_manual(values=c("plum","Red","Green","Blue")) + labs(col="Behavior")
ggsave("Figures/NestedMap.jpeg",height=8,width=11)
# Chunk 27
ggplot(state_est,aes(x=LocalHour,y=DepthMax,col=Behavior)) + geom_smooth(method = "gam", formula = y ~ s(x, k = 5)) + facet_wrap(~Animal)
# Chunk 28
byhour<-state_est %>% group_by(Animal,LocalHour,Behavior) %>% summarize(n=n()) %>% mutate(prop=n/sum(n))
ggplot(byhour,aes(x=LocalHour,y=prop,col=Behavior)) + geom_line()  + geom_point() + facet_wrap(~Animal,scales="free",ncol=1) + theme_bw() + scale_y_continuous(labels=scales::percent)
# Chunk 29
byhour<-state_est %>% group_by(LocalHour,Behavior) %>% summarize(n=n()) %>% mutate(prop=n/sum(n))
ggplot(byhour,aes(x=LocalHour,y=prop,col=Behavior)) + geom_line()  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour")
ggsave("Figures/DielFreq.svg",height=6,width=9)
ggsave("Figures/DielFreq.png",height=6,width=9)
# Chunk 30
bymonth<-state_est %>% group_by(Animal,Month,Behavior) %>% summarize(n=n()) %>% mutate(prop=n/sum(n)) %>% filter(!is.na(Month)) %>% filter(Behavior %in% c("Foraging","Resting"))
bymonth$Month<-factor(bymonth$Month,levels=month.name)
ggplot(bymonth,aes(x=Month,y=prop,col=Behavior)) + geom_line(aes(group=paste(Animal,Behavior)))  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent)
ggplot(bymonth,aes(x=Month,y=prop,fill=Behavior)) + geom_boxplot() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent)
ggsave("Figures/MonthFreq.svg",height=6,width=9)
ggsave("Figures/MonthFreq.png",height=6,width=9)
# Chunk 33
#save.image("/Users/Ben/Dropbox/Whales/Dive/WhalePhys.RData")
ggplot(pc_dive[!pc_dive$parameter %in% c("dive_new","state","sub_state"),],aes(x=Draw,y=value,col=as.factor(chain))) + geom_line() + facet_wrap(~par,scales="free")
library(momentuHMM)
?crawlWrap
a
print("hi")
a<-"hi"
a
class(a)
a<-5
class(a)
a
a<-"5"
class(a)
a + a
5 + 5
a<-c(4,5,5)
a
a + a
class(a)
data.frame(a,a)
data.frame(a,b=a)
a
b<-"hello"
a
b
d<-list(a,b)
d
d[[1]]
d[[2]]
c(a,b)
class(c(a,b))
a
list(a,b)
dist = list(step = , angle = "wrcauchy")
dist = list(step = "gamma", angle = "wrcauchy")
dist
class(dist)
dist[[1]]
dist[[2]]
dist["step"]
dist["angle"]
dist["angle"]
dist["step"]
dist[["angle"]]
hist(rgamma(1e5,3,2))
hist(rgamma(1e5,10,2))
hist(rgamma(1e5,10,1))
hist(rgamma(1e5,1,1))
hist(rgamma(1e5,1,1))
hist(rgamma(1e5,1,1))
hist(rgamma(1e5,3,2))
hist(rgamma(1e5,100,2))
hist(rgamma(1e5,10,2))
hist(rgamma(1e5,2,2))
hist(rgamma(1e5,10,2))
hist(rgamma(1e5,10,2))
?gamma
?rgamma
hist(rgamma(1e5,10,2))
hist(rgamma(1e5,10
,2))
hist(rnorm(1e5,0,3))
hist(rnorm(1e5,0,1))
hist(rnorm(1e5,0,3))
hist(rnorm(1e5,0,1))
hist(rnorm(1e5,0,100))
hist(rgamma(1e5,10,2))
hist(rgamma(1e5,1,2))
hist(rgamma(1e5,5,2))
hist(rgamma(1e5,2,5))
hist(rgamma(1e5,4,5))
hist(rgamma(1e5,4,5))
hist(rgamma(1e5,10,5))
mean(rgamma(1e5,10,5))
hist(rgamma(1e5,10,1))
hist(rgamma(1e5,100,1))
hist(rgamma(1e5,0.1,1))
hist(rgamma(1e5,0.2,1))
hist(rgamma(1e5,0.5,1))
hist(rgamma(1e5,8,1))
hist(rgamma(1e5,0.8,1))
hist(rgamma(1e5,100,1))
hist(rgamma(1e5,10,1))
hist(rgamma(1e5,5,1))
hist(rgamma(1e5,1,1))
hist(rgamma(1e5,0
,1))
hist(rgamma(1e5,0,1))
hist(rnorm(1e5,0,1))
hist(rgamma(1e5,0,1))
hist(rgamma(1e5,10,1))
hist(rgamma(1e5,1,1))
hist(rgamma(1e5,1,2))
hist(rgamma(1e5,1,5))
hist(rgamma(1e5,1,8))
hist(rgamma(1e5,2,4))
hist(rgamma(1e5,2,3))
hist(rgamma(1e5,2,6))
hist(rgamma(1e5,2,6))
hist(rgamma(1e5,2,6))
hist(rgamma(1e5,100,6))
hist(rgamma(1e5,100,3))
hist(rgamma(1e5,200,3))
hist(rgamma(1e5,200,1))
hist(rgamma(1e5,200,20))
hist(rnorm(1e5,200,20))
hist(rnorm(1e5,30,3))
hist(rnorm(1e5,30,4))
hist(rnorm(1e5,200,20))
hist(rnorm(1e5,20,20))
hist(rnorm(1e5,200,20))
hist(rnorm(1e5,20,20))
hist(rnorm(1e5,2,2))
hist(rgamma(1e5,200,20))
?rgamma
hist(rgamma(1e5,200,20))
hist(rgamma(1e5,60,3))
hist(rgamma(1e5,shape=60,scale=3))
hist(rgamma(1e5,shape=60,scale=3))
60*9
var(rgamma(1e5,shape=60,scale=3))
var(rgamma(10,shape=60,scale=3))
var(rgamma(10,shape=60,scale=3))
hist(rgamma(10,shape=60,scale=3))
hist(rgamma(100,shape=60,scale=3))
hist(rgamma(1000,shape=60,scale=3))
hist(rgamma(10000,shape=60,scale=3))
?crawlWrap
?fitHMM
pc_dive
load("/Users/Ben/Dropbox/Whales/Dive/WhalePhys.RData")
dim(mdat)
sum(is.na(mdat$Longitude))
sum(!is.na(mdat$Longitude))
mdat %>% group_by(Animal) %>% summarize(dives=sum(is.na(Longitude)))
library(tidyr)
library(ggplot2)
library(maptools)
library(shiny)
library(raster)
library(data.table)
library(ggmap)
library(leaflet)
library(dplyr)
library(stringr)
library(chron)
library(jagsUI)
library(boot)
library(knitr)
library(MCMCpack)
library(truncnorm)
newModel=T
opts_chunk$set(echo=F,warning=F,message=F,fig.width=11)
mytheme<-theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.text.y=element_blank(),axis.ticks.y=element_blank(),axis.title.x=element_blank(),axis.title.y=element_blank(),panel.grid=element_blank())
mdat %>% group_by(Animal) %>% summarize(dives=sum(is.na(Longitude)))
mdat %>% group_by(Animal) %>% summarize(dives=sum(is.na(Longitude))) %>% summarize(mean(dives),sd(dives))
mdat %>% group_by(Animal) %>% summarize(difftime(max(timestamp) - min(timestamp))
mdat %>% group_by(Animal) %>% summarize(difftime(max(timestamp) - min(timestamp)))
mdat %>% group_by(Animal) %>% summarize(t=as.character(difftime(max(timestamp) - min(timestamp))))
mdat %>% group_by(Animal) %>% summarize(t=as.character(difftime(max(timestamp), min(timestamp))))
mdat %>% group_by(Animal) %>% summarize(t=difftime(max(timestamp), min(timestamp)))
mdat %>% group_by(Animal) %>% summarize(t=difftime(max(timestamp), min(timestamp))) %>% summarize(mean(t))
#sum table
pc_dive %>% filter(!parameter %in% c("dive_new","state","eval","sub_state")) %>% group_by(parameter,Behavior,sub_state) %>% summarize(mean=round(mean(value),3),upper=round(quantile(value,0.95),3),lower=round(quantile(value,0.05),3))
head(state_est)
#sum table
pc_dive %>% filter(!parameter %in% c("dive_new","state","eval","sub_state")) %>% group_by(parameter,Behavior,sub_state) %>% summarize(mean=round(mean(value),3),upper=round(quantile(value,0.95),3),lower=round(quantile(value,0.05),3))
ggplot(data=state_est) + geom_boxplot(aes(x=Month,y=DepthMax,fill=Behavior)) + ylab("Maximum Dive Depth (km)")
state_est$Month<-factor(state_est$Month,levels=month.name)
ggplot(data=state_est) + geom_boxplot(aes(x=Month,y=DepthMax,fill=Behavior)) + ylab("Dive Depth (km)")
ggplot(data=state_est) + geom_boxplot(aes(x=Month,y=DepthMax,fill=Behavior)) + ylab("Dive Depth (m)")
ggplot(data=state_est) + geom_density(aes(x=Month,y=DepthMax,fill=Behavior)) + ylab("Dive Depth (m)") + facet_wrap(~Behavior)
ggplot(data=state_est) + geom_density(aes(y=DepthMax,fill=Month)) + ylab("Dive Depth (m)") + facet_wrap(~Behavior)
ggplot(data=state_est) + geom_density(aes(x=DepthMax,fill=Month)) + ylab("Dive Depth (m)") + facet_wrap(~Behavior)
ggplot(data=state_est) + geom_density(aes(x=DepthMax,fill=Month)) + ylab("Dive Depth (m)") + facet_wrap(~Behavior,scale="free")
ggplot(data=state_est) + geom_density(aes(x=DepthMax,fill=Month)) + ylab("Dive Depth (m)") + facet_wrap(~Behavior,scale="free",ncol=1)
state_est$DepthMax
mdat %>% group_by(Month) %>% filter(DepthMax>400) %>% summarize(n=n)
mdat %>% group_by(Month) %>% filter(DepthMax>400) %>% summarize(n=n())
ggplot(byhour,aes(x=LocalHour,y=prop,col=Behavior)) + geom_line()  + geom_point() + theme_bw() + scale_y_continuous("Frequency of Behavior",labels=scales::percent) + labs(x="Hour")
ggsave("Figures/DielFreq.svg",height=6,width=9)
ggsave("Figures/DielFreq.png",height=6,width=9)
install.packages("argosfilter")
library(argosfilter)
library(tidyr)
library(ggplot2)
library(maptools)
library(shiny)
library(raster)
library(data.table)
library(ggmap)
library(leaflet)
library(dplyr)
library(stringr)
library(chron)
library(jagsUI)
library(boot)
library(knitr)
library(MCMCpack)
library(truncnorm)
newModel=T
opts_chunk$set(echo=F,warning=F,message=F,fig.width=11)
mytheme<-theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.text.y=element_blank(),axis.ticks.y=element_blank(),axis.title.x=element_blank(),axis.title.y=element_blank(),panel.grid=element_blank())
if(!newModel){
load("/Users/Ben/Dropbox/Whales/Dive/WhalePhys.RData")
newModel=F
}
#get gps data
f<-list.files("Data/Humpback",pattern="Locations",full.names=T,recursive = T)
gdat<-lapply(f,function(x) read.csv(x,stringsAsFactors=F))
gdat<-lapply(gdat,function(x){
x$Quality<-as.character(x$Quality)
return(x)
})
gdat<-bind_rows(gdat)
#timestamp
gdat$timestamp<-as.POSIXct(gdat$Date,format="%H:%M:%S %d-%b-%Y",tz="GMT")
#
gdat<-gdat[!is.na(gdat$Latitude),]
#crop by extent
d<-SpatialPointsDataFrame(cbind(gdat$Longitude,gdat$Latitude),data=data.frame(gdat),proj4string=CRS("+proj=longlat +datum=WGS84"))
cropoly<-readShapePoly("Data/CutPolygon.shp",proj4string=CRS("+proj=longlat +datum=WGS84"))
b<-d[!is.na(d %over% cropoly)[,2],]
gdat<-b@data
#get dive data files
f<-list.files("Data/Humpback/",pattern="Behavior",full.names=T,recursive = T)
dat<-bind_rows(lapply(f,read.csv))
dat$timestamp<-as.POSIXct(dat$End,format="%H:%M:%S %d-%b-%Y",tz="GMT")
dat$Month<-months(dat$timestamp)
dat$Month<-factor(dat$Month,levels=month.name)
dat$Hour<-strftime(dat$timestamp,format="%H")
dat$Year<-years(dat$timestamp)
### for testing
gdat<-gdat %>% filter(Ptt %in% unique(dat$Ptt))
gdat<-gdat %>% dplyr::select(Animal=Ptt,timestamp,Quality,Latitude,Longitude)
gdat$Month<-months(gdat$timestamp)
gdat$Month<-factor(gdat$Month,levels=month.name)
dive<-dat %>% filter(What=="Dive")%>% dplyr::select(Animal=Ptt,timestamp,Hour,Month,Year,DepthMax,DepthMin,DurationMax,DurationMin)
dive<-bind_rows(gdat,dive)
#order by timestamp
dive<-dive %>% arrange(timestamp)
mdat<-dive
dat<-read.csv("/Users/ben/Dropbox/Whales/Data/Humpback/2013/03. 2013_WC_DAP/current-hbw-Locations.csv")
library(dplyr)
library(stringr)
library(ggplot2)
dat<-read.csv("/Users/ben/Dropbox/Whales/Data/Humpback/2013/03. 2013_WC_DAP/current-hbw-Locations.csv")
head(dat)
head(dat)
range(dat$Date)
range(as.numeric(dat$Date))
?strptime
as.POSIXct(dat$Date,"%D/%M/%Y %H:M")
as.POSIXct(as.character(dat$Date),format="%D/%M/%Y %H:M")
as.POSIXct(as.character(dat$Date),format="%d/%m/%Y %H:M")
as.character(dat$Date)
as.POSIXct(as.character(dat$Date),format="%d/%m/%Y %H:%M")
as.POSIXct(as.character(dat$Date),format="%d/%m/%Y %H:%M",tz="GMT")
dat$FDate<-as.POSIXct(as.character(dat$Date),format="%d/%m/%Y %H:%M",tz="GMT")
head(dat)
ggplot(dat) + geom_point(aes(x=Date,y=1,col=Ptt))
ggplot(dat) + geom_point(aes(x=FDate,y=1,col=Ptt))
sumdate<-dat %>% group_by(Ptt) %>% summarize(minDate=min(FDate),maxDate=max(FData))
sumdate<-dat %>% group_by(Ptt) %>% summarize(minDate=min(FDate),maxDate=max(FDate))
sumdate
dat %>% mutate(Months=months(FDate)) %>% filter(Ptt=="123232",Months %in% c(2,3,4,5,6))
dat %>% mutate(Months=months(FDate)) %>% filter(Ptt=="123232")
dat %>% mutate(Months=months(FDate)) %>% filter(Ptt=="123232") %>% head()
dat %>% mutate(Months=months(FDate)) %>% filter(Ptt=="123232",!Months %in% c("January","February","March","April","May","June","July")) %>% head()
weird<-dat %>% mutate(Months=months(FDate)) %>% filter(Ptt=="123232",!Months %in% c("January","February","March","April","May","June","July"))
mybbox<-make_bbox(data=weird,lat=Latitude,lon=Longitude,f=0.1)
troy <- get_map(location = mybbox, maptype = "toner-background")
ggmap(troy) + geom_point(data=weird,aes(x=Longitude, y=Latitude,col=as.factor(Months)),size=0.3)
weird<-dat %>% mutate(Months=months(FDate)) %>% filter(Ptt=="123232")
mybbox<-make_bbox(data=weird,lat=Latitude,lon=Longitude,f=0.1)
troy <- get_map(location = mybbox, maptype = "toner-background")
ggmap(troy) + geom_point(data=weird,aes(x=Longitude, y=Latitude,col=as.factor(Months)),size=0.3)
ggmap(troy) + geom_point(data=weird,aes(x=Longitude, y=Latitude,col=as.factor(Months)),size=0.3) + scale_color_brewer(palette = "blues")
ggmap(troy) + geom_point(data=weird,aes(x=Longitude, y=Latitude,col=as.factor(Months)),size=0.3) + scale_color_brewer(palette = "Blues")
weird$Months
levels(weird$Months)
month.name
weird %>% mutate(Months=factor(Months,levels=month.name))
weird<-weird %>% mutate(Months=factor(Months,levels=month.name))
ggmap(troy) + geom_point(data=weird,aes(x=Longitude, y=Latitude,col=as.factor(Months)),size=0.3) + scale_color_brewer(palette = "Blues")
ggmap(troy) + geom_point(data=weird,aes(x=Longitude, y=Latitude,col=as.factor(Months)),size=0.3) + scale_color_brewer(palette = "Blues") + facet_wrap(~Months)
?strptime
sumdate
animals<-data.frame(Animal=c("a","b","c"))
age<-data.frame(Animal=c("b","a","c"),Age=c(10,20,4))
animals
age
merge(animals,age,by=c("Animal"))
animals<-data.frame(Animal=c("a","b","c"))
age<-data.frame(Animal=c("b","a","c","d","e","f"),Age=c(10,20,4,5,3,5))
animals
afe
age
animals<-data.frame(Animal=c("a","b","c"))
age<-data.frame(Animal=c("b","a","c","d","e","f","f"),Age=c(10,20,4,5,3,5,5))
animals
age
?join
animals %>% semi_join(age)
animals
age
animals %>% inner_join(age)
animals<-data.frame(Animal=c("a","b","c","f"))
age<-data.frame(Animal=c("b","a","c","d","e","f","f"),Age=c(10,20,4,5,3,5,5))
animals %>% inner_join(age)
Animals
animals
age
animals %>% inner_join(age)
animals %>% inner_join(age)
m<-animals %>% inner_join(age)
m
m %>% group_by(Animal) %>% distinct()
animals
m %>% distinct()
m %>% group_by(Animal) %>% distinct()
load("/Users/Ben/Dropbox/Whales/Dive/WhalePhys.RData")
fitstat<-pc_dive %>% filter(parameter %in% c("fit","fitnew"))
fitstat<-dcast(fitstat,Draw+chain~parameter,value.var="value")
ymin<-min(c(fitstat$E,fitstat$Enew)) - min(c(fitstat$E,fitstat$Enew)) * .1
fitstat<-pc_dive %>% filter(parameter %in% c("fit","fitnew"))
fitstat
fitstat<-pc_dive %>% filter(parameter %in% c("E","Enew")) %>% group_by(parameter,Draw,chain,jAnimal) %>% summarize(fit=mean(value))
fitstat
fitstat<-pc_dive %>% filter(parameter %in% c("E","Enew")) %>% group_by(parameter,Draw,chain,Animal) %>% summarize(fit=mean(value))
fitstat
#sum table
pc_dive %>% filter(!parameter %in% c("dive_new","state","eval","sub_state")) %>% group_by(parameter,Behavior,sub_state) %>% summarize(mean=round(mean(value),3),upper=round(quantile(value,0.95),3),lower=round(quantile(value,0.05),3))
write.csv("Figures/sumtable.csv",sumtable,row.names = F)
#sum table
sumtable<-pc_dive %>% filter(!parameter %in% c("dive_new","state","eval","sub_state")) %>% group_by(parameter,Behavior,sub_state) %>% summarize(mean=round(mean(value),3),upper=round(quantile(value,0.95),3),lower=round(quantile(value,0.05),3))
write.csv("Figures/sumtable.csv",sumtable,row.names = F)
getwd()
write.csv("Figures/sumtable.csv",sumtable)
write.csv(sumtable"Figures/sumtable.csv",row.names = F)
write.csv(sumtable,"Figures/sumtable.csv",row.names = F)
