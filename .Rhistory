d<-d %>% arrange(timestamp)
startpoint<-which.min(!is.na(d$Latitude))
d<-d[startpoint:nrow(d),]
d$interval <- cut(d$timestamp,breaks = seq(min(d$timestamp), max(d$timestamp), as.difftime(step_length, units="hours")))
#If there are no argos observations, remove interval.
remove_interval<-d %>% group_by(interval) %>% summarize(n=length(!is.na(Latitude))) %>% filter(n==0)
d<-d %>% filter(!interval %in% remove_interval )
#Can we have empty argos intervals?
d<-d %>% filter(!is.na(interval)) %>% droplevels()
#get jStep and interval time
d<-d %>% group_by(interval) %>% mutate(j=difftime(timestamp,as.POSIXct(interval,tz="GMT"),units="hours")/step_length,jStep=1:n())
#which intervals are more than 12 hours apart
Track=c()
Track[1]<-1
counter=1
for(x in 2:length(unique(d$interval))){
difft<-as.numeric(difftime(as.POSIXct(unique(d$interval)[x]),as.POSIXct(unique(d$interval)[x-1]),units="hours"))
print(difft)
if(difft>step_length){
counter=counter+1
}
Track[x]<-counter
}
d<-d %>% inner_join(data.frame(interval=unique(d$interval),Track))
#set step and remove tracks less than 2 steps
d<-d %>% group_by(Track) %>% mutate(step=as.numeric(interval)) %>% filter(max(step) > 2)
#remove tracks that are shorter than 12 hours
track_time<-d %>% group_by(Track) %>% summarize(mt=difftime(max(as.POSIXct(timestamp)),min(as.POSIXct(timestamp)),units="hours")) %>% filter(mt>=12) %>% .$Track
return(d)
}
sxy<-lapply(sxy,timed,step_length=step_length)
mdat<-bind_rows(sxy)
head(mdatw)
head(mdat)
mdat %>% group_by(Animal) %>% summarize(n=n())
mdat %>% group_by(Animal,Track) %>% summarize(n=n())
mdat %>% group_by(Animal) %>% summarize(n=length(unique(Track)))
mdat %>% group_by(Animal) %>% summarize(Tracks=length(unique(Track)))
mdat<-mdat %>% filter(Animal %in% c("131134"))
head(mdat)
steps_all
steps_all<-mdat %>% group_by(Animal,Track) %>% summarize(n=length(unique(step)))
steps_all
j<-reshape2::acast(mdat,Animal~Track~step~jStep,value.var="j")
head(j)
j
j<-reshape2::acast(mdat,jAnimal~Track~step~jStep,value.var="j")
mdat$jAnimal<-as.numeric(as.factor(mdat$Animal))
idx
idx<-mdat %>% group_by(jAnimal,Track,step) %>% summarize(n=n())
odx
idx
colnames(idx)<-c("Animal","Track","step","jStep")
idx<-reshape2::acast(data=idx,Animal~Track~step)
dim(idx)
ind=length(unique(mdat$Animal))
tracks<-mdat %>% group_by(Animal) %>% summarize(tracks=length(unique(Track))) %>% .$tracks
tracks
steps_all
mdat %>% group_by(Animal,Track) %>% summarize(lenght(unique(step)))
mdat %>% group_by(Animal,Track) %>% summarize(length(unique(step)))
steps_all<-mdat %>% group_by(Animal,Track) %>% summarize(n=length(unique(step)))
steps<-reshape2::acast(steps_all,Animal~Track,value.var="n")
obs<-reshape2::melt(mdat,measure.vars=c("Longitude","Latitude"))
obs<-reshape2::acast(obs,Animal~Track~step~jStep~variable,fun.aggregate = mean)
obs[!is.finite(obs)]<-NA
mdat$argos.lc<-factor(mdat$Quality,levels=c(3,2,1,0,"A","B"))
mdat$numargos<-as.numeric(mdat$argos.lc)
obs_class<-reshape2::acast(mdat,Animal~Track~step~jStep,value.var="numargos",fun.aggregate = min)
obs_class[!is.finite(obs_class)]<-"A"
maxdive<-reshape2::acast(mdat,Animal~Track~step~jStep,value.var="DepthMax",fun.aggregate = mean)
maxdive[!is.finite(maxdive)]<-NA
diveduration<-reshape2::acast(mdat,Animal~Track~step~jStep,value.var="DurationMax")
library(tidyr)
library(ggplot2)
library(maptools)
library(shiny)
library(raster)
library(data.table)
library(ggmap)
library(leaflet)
library(dplyr)
library(stringr)
library(chron)
library(R2jags)
library(boot)
library(knitr)
library(MCMCpack)
library(truncnorm)
newModel=T
opts_chunk$set(echo=F,warning=F,message=F,fig.width=11)
mytheme<-theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.text.y=element_blank(),axis.ticks.y=element_blank(),axis.title.x=element_blank(),axis.title.y=element_blank(),panel.grid=element_blank())
if(!newModel){
load("/Users/Ben/Dropbox/Whales/Dive/WhalePhys.RData")
newModel=F
}
#get gps data
f<-list.files("/Users/Ben/Dropbox/Whales/Data/Humpback",pattern="Locations",full.names=T,recursive = T)
gdat<-lapply(f,function(x) read.csv(x,stringsAsFactors=F))
gdat<-lapply(gdat,function(x){
x$Quality<-as.character(x$Quality)
return(x)
})
gdat<-bind_rows(gdat)
#timestamp
gdat$timestamp<-as.POSIXct(gdat$Date,format="%H:%M:%S %d-%b-%Y",tz="GMT")
#
gdat<-gdat[!is.na(gdat$Latitude),]
#crop by extent
d<-SpatialPointsDataFrame(cbind(gdat$Longitude,gdat$Latitude),data=data.frame(gdat),proj4string=CRS("+proj=longlat +datum=WGS84"))
cropoly<-readShapePoly("Data/CutPolygon.shp",proj4string=CRS("+proj=longlat +datum=WGS84"))
b<-d[!is.na(d %over% cropoly)[,2],]
gdat<-b@data
#get dive data files
f<-list.files("/Users/Ben/Dropbox/Whales/Data/Humpback/",pattern="Behavior",full.names=T,recursive = T)
dat<-bind_rows(lapply(f,read.csv))
dat$timestamp<-as.POSIXct(dat$End,format="%H:%M:%S %d-%b-%Y",tz="GMT")
dat$Month<-months(dat$timestamp)
dat$Month<-factor(dat$Month,levels=month.name)
dat$Hour<-strftime(dat$timestamp,format="%H")
dat$Year<-years(dat$timestamp)
### for testing
#dat<-dat %>% filter(Ptt=="131134")
gdat<-gdat %>% filter(Ptt %in% unique(dat$Ptt))
gdat<-gdat %>% dplyr::select(Animal=Ptt,timestamp,Quality,Latitude,Longitude)
dive<-dat %>% filter(What=="Dive")%>% dplyr::select(Animal=Ptt,timestamp,Hour,Month,Year,DepthMax,DepthMin,DurationMax,DurationMin)
dive<-bind_rows(gdat,dive)
#order by timestamp
dive<-dive %>% arrange(timestamp)
ggplot(dive[,],aes(x=timestamp,y=-DepthMax)) + geom_point(size=0.1) + geom_line(size=0.1) + facet_wrap(~Animal,scales="free",ncol=3) + theme_bw()
ggsave("Figures/perindividual.jpeg",height=6,width=12)
ggplot(dive[,],aes(x=timestamp,y=-DepthMax)) + geom_point(size=0.1) + geom_line(size=0.1) + facet_wrap(~Animal,scales="free",ncol=2) + theme_bw() + geom_point(data=dive[!is.na(dive$Latitude),],y=0,col="red",size=1,aes(x=timestamp))
ggsave("Figures/perindividual.jpeg",height=6,width=12)
dive %>% group_by(Animal,Year) %>% summarize(n=n())
mdat<-dive
mybbox<-make_bbox(data=mdat,lat=Latitude,lon=Longitude,f=0.25)
troy <- get_map(location = mybbox, maptype = "toner-background")
attr_troy <- attr(troy, "bb")    # save attributes from original
# change color in raster
troy[troy == "#FFFFFF"] <- "#C0C0C0"
troy[troy == "#000000"] <- "#FFFFFF"
# correct class, attributes
class(troy) <- c("ggmap", "raster")
attr(troy, "bb") <- attr_troy
#nice to have it as a function
makemap<-function(x){
mybbox<-make_bbox(data=x,lat=Latitude,lon=Longitude,f=0.25)
troy <- get_map(location = mybbox, maptype = "toner-background")
attr_troy <- attr(troy, "bb")    # save attributes from original
# change color in raster
troy[troy == "#FFFFFF"] <- "#C0C0C0"
troy[troy == "#000000"] <- "#FFFFFF"
# correct class, attributes
class(troy) <- c("ggmap", "raster")
attr(troy, "bb") <- attr_troy
return(troy)
}
mdat %>% group_by(Animal) %>% summarize(n=n())
nrow(mdat)
#set max depth to km
#mdat$DepthMax<-mdat$DepthMax/1000
#Specifiy local time
#local time
mdat$localtime<-as.POSIXct(format(mdat$timestamp,tz="etc/GMT+3"))
mdat$LocalHour<-strftime(mdat$localtime,format="%H")
#set duration to minutes
mdat$DurationMax<-mdat$DurationMax/60
#dives can't be longer than 20 minutes
mdat<-mdat %>% filter(DurationMax<20)
#view data
ggmap(troy)+geom_path(data=mdat,aes(x=Longitude, y=Latitude,group=Animal),size=.5) + geom_point(data=mdat,aes(x=Longitude, y=Latitude)) + theme_bw() + mytheme + scale_color_continuous(low="blue",high="red") + labs(col="Max Dive Depth (km)")
#ggsave("Figures/Map.svg")
#ggsave("Figures/Map.png")
##Time is the beginning of the first point.
step_length=4
sxy<-split(mdat,mdat$Animal)
#Cut into tracks
#time diff function
timed<-function(d,step_length){
d<-d %>% arrange(timestamp)
startpoint<-which.min(!is.na(d$Latitude))
d<-d[startpoint:nrow(d),]
d$interval <- cut(d$timestamp,breaks = seq(min(d$timestamp), max(d$timestamp), as.difftime(step_length, units="hours")))
#If there are no argos observations, remove interval.
remove_interval<-d %>% group_by(interval) %>% summarize(n=length(!is.na(Latitude))) %>% filter(n==0)
d<-d %>% filter(!interval %in% remove_interval )
#Can we have empty argos intervals?
d<-d %>% filter(!is.na(interval)) %>% droplevels()
#get jStep and interval time
d<-d %>% group_by(interval) %>% mutate(j=difftime(timestamp,as.POSIXct(interval,tz="GMT"),units="hours")/step_length,jStep=1:n())
#which intervals are more than 12 hours apart
Track=c()
Track[1]<-1
counter=1
for(x in 2:length(unique(d$interval))){
difft<-as.numeric(difftime(as.POSIXct(unique(d$interval)[x]),as.POSIXct(unique(d$interval)[x-1]),units="hours"))
if(difft>step_length){
counter=counter+1
}
Track[x]<-counter
}
d<-d %>% inner_join(data.frame(interval=unique(d$interval),Track))
#set step and remove tracks less than 2 steps
d<-d %>% group_by(Track) %>% mutate(step=as.numeric(interval)) %>% filter(max(step) > 2)
#remove tracks that are shorter than 12 hours
track_time<-d %>% group_by(Track) %>% summarize(mt=difftime(max(as.POSIXct(timestamp)),min(as.POSIXct(timestamp)),units="hours")) %>% filter(mt>=12) %>% .$Track
return(d)
}
sxy<-lapply(sxy,timed,step_length=step_length)
mdat<-bind_rows(sxy)
mdat %>% group_by(Animal) %>% summarize(n=n())
mdat %>% group_by(Animal) %>% summarize(Tracks=length(unique(Track)))
###################################################
#filter by two whales for the moment
#mdat<-mdat %>% filter(Animal %in% c("131127","131136","131132","131133","154187","131134","131115","131111","131130","131116"))
mdat<-mdat %>% filter(Animal %in% c("131134"))
#remake map
#troy<-makemap(mdat,scale=6)
####################################################
#refactor animal
mdat$jAnimal<-as.numeric(as.factor(mdat$Animal))
##Split into format for JAGS
#Cast time array
j<-reshape2::acast(mdat,jAnimal~Track~step~jStep,value.var="j")
#how many observations per individual in each step
idx<-mdat %>% group_by(jAnimal,Track,step) %>% summarize(n=n())
colnames(idx)<-c("Animal","Track","step","jStep")
idx<-reshape2::acast(data=idx,Animal~Track~step)
#Individuals
ind=length(unique(mdat$Animal))
#tracks per indivudal
tracks<-mdat %>% group_by(Animal) %>% summarize(tracks=length(unique(Track))) %>% .$tracks
#steps per track
steps_all<-mdat %>% group_by(Animal,Track) %>% summarize(n=length(unique(step)))
steps<-reshape2::acast(steps_all,Animal~Track,value.var="n")
#obs array
obs<-reshape2::melt(mdat,measure.vars=c("Longitude","Latitude"))
obs<-reshape2::acast(obs,Animal~Track~step~jStep~variable,fun.aggregate = mean)
obs[!is.finite(obs)]<-NA
#argos class array
mdat$argos.lc<-factor(mdat$Quality,levels=c(3,2,1,0,"A","B"))
mdat$numargos<-as.numeric(mdat$argos.lc)
obs_class<-reshape2::acast(mdat,Animal~Track~step~jStep,value.var="numargos",fun.aggregate = min)
obs_class[!is.finite(obs_class)]<-"A"
#average dive depth array
maxdive<-reshape2::acast(mdat,Animal~Track~step~jStep,value.var="DepthMax",fun.aggregate = mean)
#fill the empty values
maxdive[!is.finite(maxdive)]<-NA
#average number of dives
diveduration<-reshape2::acast(mdat,Animal~Track~step~jStep,value.var="DurationMax")
#Dives
travel_dive_prior<-abs(rnorm(1e5,rnorm(1e5,0,1/sqrt(0.0001)),1/sqrt(runif(1e5,0,500))))
forage_dive_prior<-abs(rnorm(1e5,rnorm(1e5,50,1/sqrt(0.0001)),1/sqrt(runif(1e5,0,500))))
rest_dive_prior<-abs(rnorm(1e5,rnorm(1e5,0,1/sqrt(0.01)),1/sqrt(runif(1e5,0,500))))
divepriors<-gather(data.frame(Travel=travel_dive_prior,Forage=forage_dive_prior,Resting=rest_dive_prior))
ggplot(divepriors) + geom_density(aes(x=value,fill=key),alpha=0.5) + theme_bw()
#source jags file
source("Bayesian/ThreeState.R")
#prior cov shape
R <- diag(c(1,1))
data=list(duration=diveduration,divedepth=maxdive,argos=obs,steps=steps,R=R,ind=ind,j=j,idx=idx,tracks=tracks,argos_class=obs_class)
#paramters to track
pt<-c("Traveling","Foraging","gamma","duration_mu","duration_tau","depth_mu","depth_tau","dive_new","state","E","Enew","argos")
if(newModel){
system.time(diving<-jags.parallel(model.file = "Bayesian/ThreeState.jags",data=data,n.chains=2,parameters.to.save=pt,n.iter=100,n.burnin=0,n.thin=2,DIC=FALSE))
}
idx
library(tidyr)
library(ggplot2)
library(maptools)
library(shiny)
library(raster)
library(data.table)
library(ggmap)
library(leaflet)
library(dplyr)
library(stringr)
library(chron)
library(R2jags)
library(boot)
library(knitr)
library(MCMCpack)
library(truncnorm)
newModel=T
opts_chunk$set(echo=F,warning=F,message=F,fig.width=11)
mytheme<-theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.text.y=element_blank(),axis.ticks.y=element_blank(),axis.title.x=element_blank(),axis.title.y=element_blank(),panel.grid=element_blank())
if(!newModel){
load("/Users/Ben/Dropbox/Whales/Dive/WhalePhys.RData")
newModel=F
}
#get gps data
f<-list.files("/Users/Ben/Dropbox/Whales/Data/Humpback",pattern="Locations",full.names=T,recursive = T)
gdat<-lapply(f,function(x) read.csv(x,stringsAsFactors=F))
gdat<-lapply(gdat,function(x){
x$Quality<-as.character(x$Quality)
return(x)
})
gdat<-bind_rows(gdat)
#timestamp
gdat$timestamp<-as.POSIXct(gdat$Date,format="%H:%M:%S %d-%b-%Y",tz="GMT")
#
gdat<-gdat[!is.na(gdat$Latitude),]
#crop by extent
d<-SpatialPointsDataFrame(cbind(gdat$Longitude,gdat$Latitude),data=data.frame(gdat),proj4string=CRS("+proj=longlat +datum=WGS84"))
cropoly<-readShapePoly("Data/CutPolygon.shp",proj4string=CRS("+proj=longlat +datum=WGS84"))
b<-d[!is.na(d %over% cropoly)[,2],]
gdat<-b@data
#get dive data files
f<-list.files("/Users/Ben/Dropbox/Whales/Data/Humpback/",pattern="Behavior",full.names=T,recursive = T)
dat<-bind_rows(lapply(f,read.csv))
dat$timestamp<-as.POSIXct(dat$End,format="%H:%M:%S %d-%b-%Y",tz="GMT")
dat$Month<-months(dat$timestamp)
dat$Month<-factor(dat$Month,levels=month.name)
dat$Hour<-strftime(dat$timestamp,format="%H")
dat$Year<-years(dat$timestamp)
### for testing
#dat<-dat %>% filter(Ptt=="131134")
gdat<-gdat %>% filter(Ptt %in% unique(dat$Ptt))
gdat<-gdat %>% dplyr::select(Animal=Ptt,timestamp,Quality,Latitude,Longitude)
dive<-dat %>% filter(What=="Dive")%>% dplyr::select(Animal=Ptt,timestamp,Hour,Month,Year,DepthMax,DepthMin,DurationMax,DurationMin)
dive<-bind_rows(gdat,dive)
#order by timestamp
dive<-dive %>% arrange(timestamp)
mdat<-dive
step_length=4
sxy<-split(mdat,mdat$Animal)
d<-sxy[[1]]
d<-d %>% arrange(timestamp)
startpoint<-which.min(!is.na(d$Latitude))
d<-d[startpoint:nrow(d),]
d$interval <- cut(d$timestamp,breaks = seq(min(d$timestamp), max(d$timestamp), as.difftime(step_length, units="hours")))
remove_interval<-d %>% group_by(interval) %>% summarize(n=length(!is.na(Latitude))) %>% filter(n==0)
d<-d %>% filter(!interval %in% remove_interval )
d<-d %>% filter(!is.na(interval)) %>% droplevels()
d<-d %>% group_by(interval) %>% mutate(j=difftime(timestamp,as.POSIXct(interval,tz="GMT"),units="hours")/step_length,jStep=1:n())
Track=c()
Track[1]<-1
counter=1
for(x in 2:length(unique(d$interval))){
difft<-as.numeric(difftime(as.POSIXct(unique(d$interval)[x]),as.POSIXct(unique(d$interval)[x-1]),units="hours"))
if(difft>step_length){
counter=counter+1
}
Track[x]<-counter
}
d<-d %>% inner_join(data.frame(interval=unique(d$interval),Track))
head(d)
d %>% group_by(Track) %>% filter(timestamp > min(timestamp[!is.na(Latitude)]))
head(d)
step_length=2
d<-sxy[[1]]
d<-d %>% arrange(timestamp)
startpoint<-which.min(!is.na(d$Latitude))
d<-d[startpoint:nrow(d),]
d$interval <- cut(d$timestamp,breaks = seq(min(d$timestamp), max(d$timestamp), as.difftime(step_length, units="hours")))
remove_interval<-d %>% group_by(interval) %>% summarize(n=length(!is.na(Latitude))) %>% filter(n==0)
d<-d %>% filter(!interval %in% remove_interval )
d<-d %>% filter(!is.na(interval)) %>% droplevels()
Track=c()
Track[1]<-1
counter=1
for(x in 2:length(unique(d$interval))){
difft<-as.numeric(difftime(as.POSIXct(unique(d$interval)[x]),as.POSIXct(unique(d$interval)[x-1]),units="hours"))
if(difft>step_length){
counter=counter+1
}
Track[x]<-counter
}
d<-d %>% inner_join(data.frame(interval=unique(d$interval),Track))
d %>% group_by(Track) %>% filter(timestamp >= min(timestamp[!is.na(Latitude)]))
d<-d %>% group_by(Track) %>% filter(timestamp >= min(timestamp[!is.na(Latitude)]))
d<-d %>% group_by(interval) %>% mutate(j=difftime(timestamp,as.POSIXct(interval,tz="GMT"),units="hours")/step_length,jStep=1:n())
d<-d %>% group_by(Track) %>% mutate(step=as.numeric(interval)) %>% filter(max(step) > 2)
track_time<-d %>% group_by(Track) %>% summarize(mt=difftime(max(as.POSIXct(timestamp)),min(as.POSIXct(timestamp)),units="hours")) %>% filter(mt>=12) %>% .$Track
d
d
d<-sxy[[1]]
d<-d %>% arrange(timestamp)
startpoint<-which.min(!is.na(d$Latitude))
d<-d[startpoint:nrow(d),]
d$interval <- cut(d$timestamp,breaks = seq(min(d$timestamp), max(d$timestamp), as.difftime(step_length, units="hours")))
remove_interval<-d %>% group_by(interval) %>% summarize(n=length(!is.na(Latitude))) %>% filter(n==0)
d<-d %>% filter(!interval %in% remove_interval )
d<-d %>% filter(!is.na(interval)) %>% droplevels()
Track=c()
Track[1]<-1
counter=1
for(x in 2:length(unique(d$interval))){
difft<-as.numeric(difftime(as.POSIXct(unique(d$interval)[x]),as.POSIXct(unique(d$interval)[x-1]),units="hours"))
if(difft>step_length){
counter=counter+1
}
Track[x]<-counter
}
d<-d %>% inner_join(data.frame(interval=unique(d$interval),Track))
d<-d %>% group_by(Track) %>% filter(timestamp >= min(timestamp[!is.na(Latitude)]))
d<-d %>% group_by(interval) %>% mutate(j=difftime(timestamp,as.POSIXct(interval,tz="GMT"),units="hours")/step_length,jStep=1:n())
d<-d %>% group_by(Track) %>% droplevels() %>% mutate(step=as.numeric(interval)) %>% filter(max(step) > 2)
track_time<-d %>% group_by(Track) %>% summarize(mt=difftime(max(as.POSIXct(timestamp)),min(as.POSIXct(timestamp)),units="hours")) %>% filter(mt>=12) %>% .$Track
d
d<-d %>% group_by(Track) %>% mutate(step=as.numeric(droplevels(interval))) %>% filter(max(step) > 2)
d
d
d<-d %>% group_by(Track) %>% mutate(step=as.numeric(as.factor(interval))) %>% filter(max(step) > 2)
d
d<-d %>% group_by(Track) %>% mutate(step=as.numeric(as.factor(as.character(interval)))) %>% filter(max(step) > 2)
d
##Time is the beginning of the first point.
step_length=2
sxy<-split(mdat,mdat$Animal)
#Cut into tracks
#time diff function
timed<-function(d,step_length){
#Order and start with a valid observation
d<-d %>% arrange(timestamp)
startpoint<-which.min(!is.na(d$Latitude))
d<-d[startpoint:nrow(d),]
d$interval <- cut(d$timestamp,breaks = seq(min(d$timestamp), max(d$timestamp), as.difftime(step_length, units="hours")))
#If there are no argos observations, remove interval.
remove_interval<-d %>% group_by(interval) %>% summarize(n=length(!is.na(Latitude))) %>% filter(n==0)
d<-d %>% filter(!interval %in% remove_interval )
#Can we have empty argos intervals?
d<-d %>% filter(!is.na(interval)) %>% droplevels()
#which intervals are more than 12 hours apart
Track=c()
Track[1]<-1
counter=1
for(x in 2:length(unique(d$interval))){
difft<-as.numeric(difftime(as.POSIXct(unique(d$interval)[x]),as.POSIXct(unique(d$interval)[x-1]),units="hours"))
if(difft>step_length){
counter=counter+1
}
Track[x]<-counter
}
d<-d %>% inner_join(data.frame(interval=unique(d$interval),Track))
#First position in each track must be a valid position, recode
d<-d %>% group_by(Track) %>% filter(timestamp >= min(timestamp[!is.na(Latitude)]))
#get jStep and interval time
d<-d %>% group_by(interval) %>% mutate(j=difftime(timestamp,as.POSIXct(interval,tz="GMT"),units="hours")/step_length,jStep=1:n())
#set step and remove tracks less than 2 steps, a bit ugly to maintain subgroup order.
d<-d %>% group_by(Track) %>% mutate(step=as.numeric(as.factor(as.character(interval)))) %>% filter(max(step) > 2)
#remove tracks that are shorter than 12 hours
track_time<-d %>% group_by(Track) %>% summarize(mt=difftime(max(as.POSIXct(timestamp)),min(as.POSIXct(timestamp)),units="hours")) %>% filter(mt>=12) %>% .$Track
d
return(d)
}
sxy<-lapply(sxy,timed,step_length=step_length)
mdat<-bind_rows(sxy)
mdat<-mdat %>% filter(Animal %in% c("131134"))
###################################################
#filter by two whales for the moment
#mdat<-mdat %>% filter(Animal %in% c("131127","131136","131132","131133","154187","131134","131115","131111","131130","131116"))
mdat<-mdat %>% filter(Animal %in% c("131134"))
#remake map
#troy<-makemap(mdat,scale=6)
####################################################
#refactor animal
mdat$jAnimal<-as.numeric(as.factor(mdat$Animal))
##Split into format for JAGS
#Cast time array
j<-reshape2::acast(mdat,jAnimal~Track~step~jStep,value.var="j")
#how many observations per individual in each step
idx<-mdat %>% group_by(jAnimal,Track,step) %>% summarize(n=n())
colnames(idx)<-c("Animal","Track","step","jStep")
idx<-reshape2::acast(data=idx,Animal~Track~step)
#Individuals
ind=length(unique(mdat$Animal))
#tracks per indivudal
tracks<-mdat %>% group_by(Animal) %>% summarize(tracks=length(unique(Track))) %>% .$tracks
#steps per track
steps_all<-mdat %>% group_by(Animal,Track) %>% summarize(n=length(unique(step)))
steps<-reshape2::acast(steps_all,Animal~Track,value.var="n")
#obs array
obs<-reshape2::melt(mdat,measure.vars=c("Longitude","Latitude"))
obs<-reshape2::acast(obs,Animal~Track~step~jStep~variable,fun.aggregate = mean)
obs[!is.finite(obs)]<-NA
#argos class array
mdat$argos.lc<-factor(mdat$Quality,levels=c(3,2,1,0,"A","B"))
mdat$numargos<-as.numeric(mdat$argos.lc)
obs_class<-reshape2::acast(mdat,Animal~Track~step~jStep,value.var="numargos",fun.aggregate = min)
obs_class[!is.finite(obs_class)]<-"A"
#average dive depth array
maxdive<-reshape2::acast(mdat,Animal~Track~step~jStep,value.var="DepthMax",fun.aggregate = mean)
#fill the empty values
maxdive[!is.finite(maxdive)]<-NA
#average number of dives
diveduration<-reshape2::acast(mdat,Animal~Track~step~jStep,value.var="DurationMax")
#source jags file
source("Bayesian/ThreeState.R")
#prior cov shape
R <- diag(c(1,1))
data=list(duration=diveduration,divedepth=maxdive,argos=obs,steps=steps,R=R,ind=ind,j=j,idx=idx,tracks=tracks,argos_class=obs_class)
#paramters to track
pt<-c("Traveling","Foraging","gamma","duration_mu","duration_tau","depth_mu","depth_tau","dive_new","state","E","Enew","argos")
if(newModel){
system.time(diving<-jags.parallel(model.file = "Bayesian/ThreeState.jags",data=data,n.chains=2,parameters.to.save=pt,n.iter=100,n.burnin=0,n.thin=2,DIC=FALSE))
}
argos_class
argos_class[1,1,2,1]
unique(argos_class)
unique(as.numeric(argos_class))_
unique(as.numeric(argos_class)))
unique(as.numeric(argos_class))
head(mdat)
head(mdat %>% dplyr::select(Animal,numargos,argos.lc))
mdat %>% group_by(numargos,argos.lc) %>% distinct()
mdat %>% group_by(numargos,argos.lc) %>% summarize(n=n())
obs_class
obs_class
obs_class<-reshape2::acast(mdat,Animal~Track~step~jStep,value.var="numargos",fun.aggregate = min)
obs_class[!is.finite(obs_class)]<-5
obs_class
