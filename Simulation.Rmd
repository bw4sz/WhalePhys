---
title: "Foraging Simulation"
author: "Ben Weinstein"
date: `r Sys.time()`
output: html_document
---

#Parameters

## Empirical parameters estimated from whale tagging data

Behavior allocation (Foraging,Traveling) at each time step (Binomial($\alpha$))

Average maximum depth (LogNormal($\mu = dive_\mu$, sd= \frac{1/dive_\tau}))

Average number of dives (Poisson($lambda = divecount$)

## Parameters estimated from literature 

Initial body mass (M) = 39614 kg (Tyson et al. 2016, Lockyer 1976)

Metabolic rate while traveling ($\m_{traveling}$) = 2.32KJ/sec, Tyson et al. (2016),Williams et al. (2001).

Metabolic rate while traveling ($\m_{foraging}$) = 4.14KJ/sec, Tyson et al. (2016),Williams et al. (2001).

Lunges at depth. $\frac{\text{1 lunge}}{text{50m}}$. Ware 2011 reported ~40 sec interlunge time, with 1.5m/s dive speed. Use this as the mean number in a poisson draw 

$$Lunges \sim Poisson(\lambda=\frac{dive_depth}{50}$$)

Energetic cost per lunge ($E_{lunge}$) = 298.08K J

**this seems widly too low** 

Energetic gain per lunge 41KJ/sec (Tyson et al 2016) * 15.5 sec = 635 KJ per lunge

Metabolic efficiency, energy lost to extretion (Bejarano et al. 2017)

$$ Beta(43.60,5.71) $$

```{r}
hist(rbeta(1e5,43.60,5.71))
```

```{r}
library(dplyr)
library(ggplot2)
library(truncnorm)
```

```{r}
#encode foraging parameters
pars<-list(
  draws=120, ## number of 6 hour periods
  depth_mu2 = 0.22 , ## Average dive depth
  depth_tau2 = sqrt(1/92) ,## variance in dive depth
  lambda_count2=4.5, ## average number of dives during foraging
  lgain=635, ## KJ gain per lunge
  lcost=298, ## KJ cost per lunche
  lungef=50*1000, ## Number of lunges per X km depth
  mass= 39614, ## initial mass of whale
  metabolic_efficiency=rbeta(1,43.60,5.71) ## % efficiency of metabolic action (loss to extretion)
  )
```

```{r}
##########
#Functions
##########

behavior<-function(pars){
  states<-c()
  
  #initial state is traveling
  states[1]<-(1)
  
  for(x in 2:pars$draws){
    
    #probability of staying, or switching, to traveling state
    travel_prob=pars$alpha %>% filter(Previous_State==states[x-1]) %>% sample_n(1) %>% .$value
    
    #pick next state
    states[x]<-rbinom(1,1,travel_prob)
  }
  
  #total hours of foraging
return(states)
}
```

```{r}
#foraging energy functions
sim_lunges<-function(divedepth){
  rpois(divedepth * pars$lungef)
}

sim_lcost<-function(lunges){
  return(lunges*pars$lcost)
}

sim_lgain<-function(lunges){
  return(lunges *pars$lgain )
}
```


```{r}
#Traveling state function

traveling_state<-function(pars){
    
    #Cost of traveling
    energy<-metabolic_traveling(pars)
    
  return(energy)
  }
 
```

```{r}

#Foraging state function

foraging_state<-function(pars){
    divecount<-rpois(1,pars$lambda_count2)
    
    dive_energy<-c()
    for(dive in 1:divecount){
      
      #dive length
      divedepth<-rtruncnorm(1,pars$depth_mu2,pars$depth_tau2,a=0.01)  
      
      #lunges 
      lunges<-sim_lunges(divedepth)
      
      #gain per lunge
      gain_lunge<-sim_lgain(lunges)
      
      #costs per lunche
      cost_lunge<-sim_lcost(lunges)
      
      dive_energy[x]<-gain_lunge-cost_lunge
    }
    
    #sum across dives
    energy<-sum(dive_energy)
     return(energy)
  }
 
```

```{r}
simulation<-function(pars){
  
  simid<-runif(1,0,10000000)
  
  #foraging states in a given time interval
  states<-behavior(pars)
  
  energy<-c()
  #time foraging periods
  for (state in 1:states){
    
    #if foraging
    if(state==1){
      energy[x]<-foraging_state(pars)
    } else{
      energy[x]<-traveling(pars)
    }
  }
  
  #Convert energy to calories
  energy<-energy * metabolic_efficiency
  return(data.frame(pars$simid,1:states,energy))
}
```

```{r}
results<-list()
for(x in 1:length(iterations) ){
  results[[x]]<-simulation()
}
results<-bind_rows(results)
```

# Future directions

* Variable krill swarm size

* Temporal variation in foraging rates

* Explicitely spatial structure, movement, krill swarms, etc.